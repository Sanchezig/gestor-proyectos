<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROD - WTW - Gestor de Proyectos</title>
	<link rel="icon" type="image/x-icon" href="calendar.ico">
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-background: #f5f3f8;
            --color-surface: #ffffff;
            --color-text: #221933;
            --color-text-secondary: #6b607d;
            --color-primary: #7a1ea2;
            --color-primary-hover: #5c177a;
            --color-success: #00a58c;
            --color-warning: #ffb547;
            --color-danger: #d32f2f;
            --color-border: #e0d6ec;
            --color-day-light: #efe2ff;
            --color-checkbox-bg: #f4eefb;
            --shadow-soft: 0 4px 16px rgba(14, 0, 40, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top left, #f2ebff 0, #f5f3f8 40%, #f5f3f8 100%);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 230px;
            background: linear-gradient(180deg, #2a1b4a 0%, #321d57 40%, #3a1f63 100%);
            color: #f8f4ff;
            padding: 22px 18px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-soft);
            position: relative;
        }




        .sidebar-logo {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: #d5c7f0;
            margin-bottom: 18px;
        }

        .sidebar-title {
            font-weight: 600;
            margin: 18px 0 10px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #c6b7e9;
        }

        .sidebar-content {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px;
  /* Ocultar scrollbar */
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.sidebar-content::-webkit-scrollbar {
  display: none;
}

        .sidebar-list {
            list-style: none;
        }


        .sidebar-list {
            list-style: none;
        }

        .sidebar-list li {
            margin-bottom: 6px;
        }

        .sidebar-list button {
            background: transparent;
            border: none;
            color: #f3ecff;
            cursor: pointer;
            font-size: 13px;
            padding: 8px 10px;
            width: 100%;
            text-align: left;
            border-radius: 6px;
            transition: background 160ms ease, transform 120ms ease;
        }

        .sidebar-list button:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(1px);
        }

        .sidebar-list button.active {
            background: #f3ecff;
            color: #2b173f;
            font-weight: 600;
        }

        /* ===== ESTILOS PARA COLLAPSE/EXPAND DEL SIDEBAR ===== */
        .sidebar-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            font-weight: 600;
            user-select: none;
            transition: all 140ms ease;
            margin-bottom: 8px;
            color: #e0d6ec;
        }

        .sidebar-section-header:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .section-toggle-icon {
            font-size: 0;
            width: 12px;
            height: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 200ms ease;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .section-toggle-icon::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid #e0d6ec;
            display: block;
            transition: transform 200ms ease;
        }

        .section-toggle-icon[data-collapsed="true"] {
            transform: rotate(-90deg);
        }

        .section-title {
            flex: 1;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .projects-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow: hidden;
            transition: max-height 300ms cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 300ms ease;
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 16px;
        }

        .projects-list.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .projects-list li {
            padding: 0;
            margin: 0;
        }

        .projects-list button {
            background: transparent;
            border: none;
            color: #f3ecff;
            cursor: pointer;
            font-size: 13px;
            padding: 8px 10px;
            width: 100%;
            text-align: left;
            border-radius: 6px;
            transition: all 120ms ease;
        }

        .projects-list button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }

        .projects-list button.active {
            background: #f3ecff;
            color: #2b173f;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(243, 236, 255, 0.3);
        }

        #activosSection,
        #completadosSection {
            margin-bottom: 12px;
        }

        .btn-new-project {
            width: 100%;
            padding: 10px 12px;
            background: #f3ecff;
            color: #2b173f;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            transition: background 160ms ease, transform 120ms ease, box-shadow 160ms ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
        }

        .btn-new-project:hover {
            background: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.24);
        }

        .comment-checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            position: relative;
        }

        .comment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .comment-entry.completed {
            opacity: 0.6;
            background: #f0f0f0;
            border-left-color: #00a58c;
        }

        .comment-entry.completed .comment-text {
            text-decoration: line-through;
            color: var(--color-text-secondary);
        }

        .completion-badge {
            display: inline-block;
            background: #00a58c;
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 999px;
            margin-left: 8px;
        }

        .user-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            margin-top: auto;
        }



        .user-icon {
            font-size: 24px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 50%;
        }

        .user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #f8f4ff;
        }

        .user-change-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #d5c7f0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 140ms ease;
            align-self: flex-start;
        }

        .user-change-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: #f8f4ff;
        }

        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 14px 20px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(23, 0, 60, 0.08);
        }

        .toolbar-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .toolbar h2 {
            font-size: 18px;
            font-weight: 650;
        }

        .toolbar-caption {
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .view-toggle {
            display: inline-flex;
            padding: 3px;
            background: #f3ecff;
            border-radius: 999px;
            border: 1px solid #e0d6ec;
            gap: 3px;
        }

        .view-toggle button {
            padding: 6px 14px;
            background: transparent;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            color: var(--color-text-secondary);
            transition: all 160ms ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .view-toggle button.active {
            background: #ffffff;
            color: var(--color-primary);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(23, 0, 60, 0.12);
        }

        .content-area {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .daily-view {
            display: none;
        }

        .daily-view.active {
            display: block;
        }

        .week-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background: var(--color-surface);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-soft);
        }

        .week-nav-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 7px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 160ms ease, transform 120ms ease, box-shadow 160ms ease;
            box-shadow: 0 3px 10px rgba(90, 10, 140, 0.3);
        }

        .week-nav-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-0.5px);
            box-shadow: 0 5px 14px rgba(90, 10, 140, 0.34);
        }

        .week-info {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .daily-mode-toggle {
            margin: 10px 0 14px;
            display: inline-flex;
            padding: 3px;
            background: #f3ecff;
            border-radius: 999px;
            border: 1px solid #e0d6ec;
            gap: 3px;
        }

        .daily-mode-toggle button {
            padding: 5px 12px;
            border-radius: 999px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 11px;
            color: var(--color-text-secondary);
            transition: all 140ms ease;
        }

        .daily-mode-toggle button.active {
            background: #ffffff;
            color: var(--color-primary);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(23, 0, 60, 0.12);
        }

        .daily-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-soft);
        }

        .daily-table th,
        .daily-table td {
            padding: 8px 8px;
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            text-align: left;
            font-size: 12px;
        }

        .daily-table th:last-child,
        .daily-table td:last-child {
            border-right: none;
        }

        .daily-table th {
            background: #2a1b4a;
            color: #f5f3f8;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.06em;
        }

        .daily-table th.day-header {
            background: var(--color-day-light);
            color: var(--color-text);
            font-weight: 600;
            text-transform: none;
            font-size: 12px;
            text-align: center;
        }

        .today-header {
            box-shadow: inset 0 -3px 0 #7a1ea2;
            color: #7a1ea2;
        }

        .daily-table thead tr.filter-row th {
            background: #f5f0ff;
            border-bottom: 1px solid var(--color-border);
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            font-size: 11px;
            background: #fbf9ff;
            color: var(--color-text);
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px rgba(122, 30, 162, 0.18);
            background: #ffffff;
        }

        .vacation-badge {
            display: inline-block;
            background: linear-gradient(135deg, #9b59b6 0%, #7a1ea2 100%);
            color: white;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 999px;
            margin: 0 1px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(122, 30, 162, 0.3);
            letter-spacing: 0.3px;
        }

        .daily-table tbody tr:hover td {
            background: #faf7ff;
        }

        .daily-table tbody tr.selected-row td {
            background: #efe2ff;
        }

        .project-name-cell {
            cursor: pointer;
            font-weight: 600;
            color: #2a1b4a;
        }

        .project-name-cell:hover {
            text-decoration: underline;
        }

        .daily-table td.daily-cell {
            cursor: default;
            min-width: 170px;
            position: relative;
            background: #faf7ff;
            min-height: 70px;
            vertical-align: top;
            transition: background 160ms ease, box-shadow 160ms ease, transform 120ms ease;
        }

        .daily-table td.daily-cell:hover {
            background: #f3ecff;
            box-shadow: inset 0 0 0 1px #d2bff2;
        }

        .daily-table td.daily-cell.has-comment {
            background: #fff8e6;
            border-left: 3px solid #ffb547;
        }

        .holiday-cell {
            background: linear-gradient(135deg, #ffe8ee 0%, #fff0f3 100%);
            position: relative;
        }

        .holiday-cell.has-comment {
            background: linear-gradient(135deg, #ffd4e0 0%, #ffe0ea 100%);
        }

        .holiday-header {
            box-shadow: inset 0 -3px 0 #d32f2f;
            color: #d32f2f;
        }


        .holiday-cell::after {
            content: "";
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            color: #d32f2f;
            font-weight: 700;
            opacity: 0.5;
            letter-spacing: 0.5px;
        }


        .daily-cell-content {
            font-size: 11px;
            color: var(--color-text-secondary);
            max-height: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .daily-cell-meta {
            font-size: 10px;
            color: var(--color-text-secondary);
        }

        .daily-cell-preview {
            font-size: 11px;
            color: var(--color-text);
        }

        .daily-actions {
            margin-top: 4px;
            display: flex;
            gap: 4px;
        }

        .daily-action-btn {
            border: none;
            background: rgba(42, 27, 74, 0.06);
            border-radius: 999px;
            padding: 1px 6px;
            font-size: 10px;
            cursor: pointer;
            color: var(--color-text-secondary);
            transition: background 140ms ease, color 140ms ease;
        }

        .daily-action-btn:hover {
            background: #2a1b4a;
            color: #f5f3f8;
        }

        .state-select {
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            background: #faf7ff;
            color: var(--color-text);
            transition: border 120ms ease, box-shadow 120ms ease, background 120ms ease;
        }

        .state-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(122, 30, 162, 0.18);
            background: #ffffff;
        }

        .project-ficha {
            position: relative;
            display: none;
            max-width: 1000px;
        }

        .project-ficha.active {
            display: block;
        }

        .ficha-header {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
        }


        .ficha-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #2a1b4a;
        }

        .ficha-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 10px;
        }

        .ficha-field {
            display: flex;
            flex-direction: column;
        }

        .ficha-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
            letter-spacing: 0.06em;
        }

        .ficha-value {
            font-size: 13px;
            color: var(--color-text);
        }

        .ficha-value input,
        .ficha-value select,
        .ficha-value textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            font-size: 13px;
            font-family: inherit;
            background: #f8f6ff;
        }

        .ficha-value textarea {
            min-height: 60px;
            resize: vertical;
        }

        .ficha-value input:focus,
        .ficha-value select:focus,
        .ficha-value textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(122, 30, 162, 0.18);
            background: #ffffff;
        }

        .ficha-section {
            background: var(--color-surface);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-primary);
            color: #2a1b4a;
        }

        .checkbox-group-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .checkbox-group-2col {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 8px 10px;
            background: var(--color-checkbox-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: background 160ms ease, transform 120ms ease, box-shadow 160ms ease;
            border: 1px solid transparent;
        }

        .checkbox-item:hover {
            background: #ece0ff;
            box-shadow: 0 2px 8px rgba(23, 0, 60, 0.14);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 10px;
            cursor: pointer;
            margin-top: 2px;
        }

        .checkbox-item.checked {
            background: #e4fff8;
            border-color: #00a58c;
        }

        .prereq-doc {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .comments-box {
            background: var(--color-checkbox-bg);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 14px;
            max-height: 420px;
            overflow-y: auto;
            font-size: 12px;
        }


        .comment-entry {
            background: var(--color-surface);
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--color-primary);
            border-radius: 6px;
            line-height: 1.4;
            box-shadow: 0 2px 6px rgba(23, 0, 60, 0.06);
            position: relative;
        }

        .comment-header {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 3px;
        }

        .comment-meta {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: 5px;
        }

        .comment-text {
            color: var(--color-text);
            word-wrap: break-word;
        }

        .comment-urgency {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .comment-urgency.maxima {
            background: #ffebee;
            color: var(--color-danger);
        }

        .comment-urgency.alta {
            background: #fff4e0;
            color: var(--color-warning);
        }

        .comment-urgency.normal {
            background: #e5f2ff;
            color: var(--color-primary);
        }

        .comment-incident-flag {
            margin-left: 5px;
            color: var(--color-danger);
            font-weight: 700;
        }

        .comment-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .comment-action-btn {
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 120ms ease, color 120ms ease;
        }

        .comment-action-btn:hover {
            background: rgba(34, 25, 51, 0.06);
            color: var(--color-text);
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 0, 40, 0.45);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 22px;
            border-radius: 14px;
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 40px rgba(10, 0, 30, 0.6);
            border: 1px solid var(--color-border);
        }

        .modal-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #2a1b4a;
        }

        .form-group {
            margin-bottom: 13px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            letter-spacing: 0.06em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 9px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: #f8f6ff;
            transition: border 120ms ease, box-shadow 120ms ease, background 120ms ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(122, 30, 162, 0.18);
            background: #ffffff;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
            margin-top: 6px;
        }

        .checkbox-label input {
            width: auto;
            margin-right: 7px;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 9px 10px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 160ms ease, transform 120ms ease, box-shadow 160ms ease;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(90, 10, 140, 0.35);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(90, 10, 140, 0.4);
        }

        .btn-cancel {
            background: #f3ecff;
            color: var(--color-text);
        }

        .btn-cancel:hover {
            background: #ebe1ff;
        }

        .modal-project {
            max-width: 620px;
        }

        .prerequisites-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .prerequisite-item {
            display: flex;
            align-items: flex-start;
            padding: 7px 9px;
            background: var(--color-checkbox-bg);
            border-radius: 8px;
        }

        .prerequisite-item input {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
            margin-top: 2px;
        }

        .prereq-doc-input {
            margin-top: 4px;
            font-size: 11px;
        }

        .progress-indicator-centered {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex: 1;
            margin-right: 20px;
        }


        .progress-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: #e0d6ec;
            stroke-width: 8;
        }

        .progress-ring-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 264;
            transition: stroke-dashoffset 600ms ease, stroke 400ms ease;
        }

        .progress-text {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-input {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            line-height: 1;
            border: none;
            background: transparent;
            width: 60px;
            text-align: center;
            padding: 4px;
            border-radius: 6px;
            transition: background 200ms ease;
            cursor: pointer;
        }

        .progress-input:hover {
            background: rgba(122, 30, 162, 0.08);
        }

        .progress-input:focus {
            outline: none;
            background: rgba(122, 30, 162, 0.12);
        }

        .progress-input::-webkit-inner-spin-button,
        .progress-input::-webkit-outer-spin-button {
            opacity: 1;
        }

        .progress-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1ecff;
        }

        ::-webkit-scrollbar-thumb {
            background: #b39cd6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8c72c4;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
                padding: 18px 14px;
            }

            .ficha-row {
                grid-template-columns: 1fr 1fr;
            }

            .daily-table th,
            .daily-table td {
                padding: 7px;
                font-size: 11px;
            }
        }

        .project-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .project-title-section {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .progress-indicator-centered {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 0 0 auto;
            margin: 0;
        }

        .progress-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
        }

        .progress-input {
            font-size: 16px;
            width: 40px;
        }

        .progress-label {
            font-size: 7px;
            margin-top: 1px;
        }




        .project-title-section {
            flex: 1;
        }

        .project-mini-indicators {
            display: inline-flex;
            gap: 10px;
            margin-left: 20px;
            align-items: center;
        }

        .mini-indicator {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			font-size: 11px;
			color: var(--color-text-secondary);
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			transition: background 140ms ease;
			position: relative;
			overflow: visible;
		}


        .mini-indicator:hover {
            background: rgba(122, 30, 162, 0.05);
        }

        .mini-label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-size: 9px;
        }

        .mini-value {
            font-weight: 600;
            font-size: 11px;
        }

        .mini-indicator.priority-alta .mini-value {
            color: #7a1ea2;
        }

        .mini-indicator.priority-media .mini-value {
            color: #9575cd;
        }

        .mini-indicator.priority-baja .mini-value {
            color: #9e9e9e;
        }

        .mini-indicator.impact-alto .mini-value {
            color: #ab47bc;
        }

        .mini-indicator.impact-medio .mini-value {
            color: #4fc3f7;
        }

        .mini-indicator.impact-bajo .mini-value {
            color: #81d4fa;
        }

        .summary-table .vacation-current,
        .summary-table .vacation-willis {
            color: #4a90e2;
            font-weight: 600;
            text-align: center !important;
        }

        .summary-table .vacation-willis {
            color: #e67e22;
        }

        .summary-table thead th:nth-child(2),
        .summary-table thead th:nth-child(3) {
            text-align: center !important;
        }


        .status-badge-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 160ms ease;
            position: relative;
            border: 1.5px solid;
        }

        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .status-badge.status-verde {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #66bb6a;
        }

        .status-badge.status-ámbar {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffa726;
        }

        .status-badge.status-rojo {
            background: #ffebee;
            color: #c62828;
            border-color: #ef5350;
        }

        .status-icon {
            font-size: 13px;
        }

        .status-text {
            font-size: 11px;
            letter-spacing: 0.3px;
        }

        .indicator-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 6px;
            z-index: 9999;
            min-width: 160px;
            display: none;
            border: 1px solid var(--color-border);
        }

        .indicator-dropdown.active {
            display: block;
        }

        .team-view {
            display: none;
            max-width: 100%;
        }

        .team-view.active {
            display: block;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--color-surface);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-soft);
            gap: 20px;
        }

        .btn-add-vacation {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 7px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 160ms ease;
            white-space: nowrap;
            box-shadow: 0 3px 10px rgba(90, 10, 140, 0.3);
            flex-shrink: 0;
        }

        .btn-add-vacation:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 5px 14px rgba(90, 10, 140, 0.4);
        }



        .month-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-nav-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 160ms ease;
        }

        .month-nav-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .current-month {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            min-width: 200px;
            text-align: center;
        }

        .vacation-calendar {
            background: var(--color-surface);
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
            overflow: hidden;
        }

        .calendar-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            width: 100%;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-background);
        }


        .calendar-scroll-container::-webkit-scrollbar {
            height: 10px;
        }

        .calendar-scroll-container::-webkit-scrollbar-track {
            background: #f1ecff;
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background: #b39cd6;
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #8c72c4;
        }

        .calendar-table {
            width: auto;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 100%;
        }


        .calendar-table thead th {
            background: #2a1b4a;
            color: #f8f4ff;
            font-weight: 600;
            font-size: 9px;
            padding: 6px 2px;
            border: 1px solid #1a0f2a;
            text-align: center;
            vertical-align: middle;
        }

        .calendar-table thead th.weekend-header {
            background: #1a0f2a;
            color: #bbb;
        }

        .calendar-table thead th.month-header {
            background: #7a1ea2;
            font-size: 11px;
            font-weight: 700;
            padding: 10px;
        }


        .calendar-table .name-column {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #f3ecff;
            font-weight: 600;
            padding: 8px 12px;
            border-right: 2px solid #7a1ea2;
            min-width: 100px;
            max-width: 100px;
            width: 100px;
            text-align: left;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }


        .calendar-table thead th.name-column {
            z-index: 20;
            background: #2a1b4a;
            color: #f8f4ff;
        }

        .calendar-table tbody td {
            border: 1px solid var(--color-border);
            text-align: center;
            vertical-align: middle;
            width: 36px;
            min-width: 36px;
            max-width: 36px;
            height: 36px;
            padding: 0;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 120ms ease;
            position: relative;
        }


        .calendar-table tbody td:not(.name-column):hover {
            transform: scale(1.15);
            z-index: 5;
            box-shadow: 0 0 8px rgba(122, 30, 162, 0.4);
        }

        .calendar-table tbody td.weekend {
            background: #e0e0e0;
        }

        .calendar-table tbody td.holiday {
            background: #ffe8ee;
        }

        .calendar-table tbody td.vacation-current-year {
            background: #4a90e2;
            color: white;
        }

        .calendar-table tbody td.vacation-previous-year {
            background: #9b59b6;
            color: white;
        }

        .calendar-table tbody td.vacation-willis-choice {
            background: #e67e22;
            color: white;
        }

        .calendar-table tbody td.weekend.vacation-willis-choice {
            background: #c66e1a;
        }

        .calendar-table tbody td.month-separator,
        .calendar-table thead th.month-separator {
            border-left: 3px solid #7a1ea2 !important;
        }

        .calendar-table tbody td.weekend.vacation-current-year,
        .calendar-table tbody td.weekend.vacation-previous-year,
        .calendar-table tbody td.weekend.vacation-willis-choice {
            background: linear-gradient(135deg, #f5f5f5 0%, #f5f5f5 50%, #4a90e2 50%, #4a90e2 100%);
        }

        .team-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .vacation-summary {
            background: var(--color-surface);
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
            padding: 20px;
            margin-top: 20px;
        }

        .summary-title {
            font-size: 16px;
            font-weight: 700;
            color: #2a1b4a;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-primary);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .summary-table thead th {
            background: #f3ecff;
            color: var(--color-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 2px solid var(--color-primary);
        }

        .summary-table tbody tr {
            border-bottom: 1px solid var(--color-border);
            transition: background 120ms ease;
        }

        .summary-table tbody tr:hover {
            background: #faf7ff;
        }

        .summary-table tbody tr:last-child {
            border-bottom: none;
        }

        .summary-table td {
            padding: 12px 12px;
        }

        .summary-table .member-name {
            font-weight: 600;
            color: #2a1b4a;
        }

        .summary-table .vacation-current {
            color: #4a90e2;
            font-weight: 600;
        }

        .summary-table .vacation-willis {
            color: #e67e22;
            font-weight: 600;
        }

        .summary-table .total-column {
            background: #f3ecff;
            color: var(--color-primary);
            font-weight: 700;
            text-align: center;
        }


        .stat-card {
            background: var(--color-surface);
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-soft);
        }

        .stat-label {
            font-size: 10px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .legend-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 12px;
            background: #faf9fc;
            border-radius: 8px;
            flex-wrap: wrap;
        }


        .progress-input::-webkit-outer-spin-button,
        .progress-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        .progress-input {
            -moz-appearance: textfield;
            appearance: textfield;
        }


        .right-sidebar {
    position: absolute;
    top: 0;
    left: 100%;
    margin-left: 20px;
    width: 320px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 10;
    /* IMPORTANTE: Asegurar altura máxima si quieres que el scroll funcione dentro de los widgets */
    max-height: calc(100vh - 40px); 
    overflow-y: auto; /* Scroll para la barra lateral completa si es muy alta */
}

        .widget-box {
    background: #ffffff !important;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(14, 0, 40, 0.08);
    border: 1px solid #e0d6ec;
    padding: 16px;
    width: 100%;
    display: flex; /* Cambiar de block a flex para manejar alturas internas */
    flex-direction: column;
    /* Eliminar altura fija si la hubiera, o poner min-height */
}
		
		/* --- ESTILOS PARA EL HISTORIAL DE ESTADOS --- */

/* 1. Contenedor del historial antiguo (con scroll) */
.status-history-container {
    max-height: 150px;         /* Altura máxima fija */
    overflow-y: auto;          /* Scroll vertical */
    margin-bottom: 15px;
    padding-right: 5px;
    border-top: 1px solid #eee;
    padding-top: 10px;
    background-color: #fbf9ff; /* Fondo muy suave */
    border-radius: 6px;
}

/* Scrollbar fino y elegante */
.status-history-container::-webkit-scrollbar {
    width: 5px;
}
.status-history-container::-webkit-scrollbar-thumb {
    background: #d1c4e9;
    border-radius: 3px;
}

/* 2. Estilo para el Estado ACTUAL (el de arriba) */
.current-status-highlight {
    background-color: #fff;
    border: 1px solid #7a1ea2; /* Borde morado destacado */
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 4px 10px rgba(122, 30, 162, 0.08);
    position: relative;
}
.current-status-highlight .status-content {
    text-indent: 0 !important;
    padding-left: 0 !important;
    margin-left: 0 !important;
}



/* 3. Items del historial */
.history-item {
    padding: 8px 10px;
    border-bottom: 1px solid #e0d6ec;
    margin-bottom: 4px;
    font-size: 11px;
}
.history-item:last-child {
    border-bottom: none;
}



        .status-input-area textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            font-size: 12px;
            resize: none;
            margin-bottom: 6px;
            font-family: inherit;
            background: #ffffff;
        }

        .btn-save-status {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: background 140ms ease;
        }

        .btn-save-status:hover {
            background: var(--color-primary-hover);
        }




        .capacity-widget-title {
            font-size: 13px;
            font-weight: 700;
            color: #2a1b4a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .capacity-week-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            background: #f3ecff;
            padding: 8px;
            border-radius: 8px;
        }

        .capacity-week-nav button {
            background: var(--color-primary);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 160ms ease;
        }

        .capacity-week-nav button:hover {
            background: var(--color-primary-hover);
            transform: scale(1.1);
        }

        .capacity-week-info {
            flex: 1;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text);
        }

        .capacity-weeks-container {
            display: flex;
            gap: 12px;
        }

        .capacity-week-block {
            flex: 1;
            background: #faf7ff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--color-border);
            min-width: 0;
        }


        .capacity-week-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-primary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .capacity-user-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .capacity-user-icon {
            width: 28px;
            height: 28px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .capacity-input-wrapper {
            flex: 1;
            position: relative;
        }

        .capacity-input {
            width: 100%;
            padding: 6px 28px 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            background: white;
            transition: all 160ms ease;
        }

        .capacity-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(122, 30, 162, 0.18);
        }

        .capacity-percent-symbol {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--color-text-secondary);
            pointer-events: none;
        }

        .capacity-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 140ms ease;
        }

        .capacity-close-btn:hover {
            background: rgba(122, 30, 162, 0.1);
            color: var(--color-primary);
        }

        .prereq-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--color-checkbox-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 160ms ease;
        }

        .prereq-item-row:hover {
            background: #ece0ff;
        }

        .prereq-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .prereq-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-success);
            margin-top: 0;
        }

        .prereq-label {
            font-size: 13px;
            color: var(--color-text);
            font-weight: 500;
        }


        .prereq-label.completed {
            color: var(--color-text-secondary);
        }


        .prereq-label.na-active {
            color: var(--color-text-secondary);
            font-style: italic;
            text-decoration: none;
        }

        .prereq-na-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--color-text-secondary);
            background: rgba(255, 255, 255, 0.5);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .prereq-na-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--color-text-secondary);
        }


		.status-history-item {
			background: #f8f6ff;
			border-left: 3px solid var(--color-primary);
			padding: 10px;
			border-radius: 6px;
			margin-bottom: 10px;
		}

		.status-meta {
			display: flex;
			justify-content: space-between;
			font-size: 10px;
			color: var(--color-text-secondary);
			margin-bottom: 4px;
			font-weight: 600;
		}

		.status-content {
			font-size: 12px;
			color: var(--color-text);
			line-height: 1.4;
			white-space: pre-wrap;
		}

		#current-status-display {
			margin-top: 14px;
		}

        .status-input-area textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            font-size: 12px;
            resize: none;
            margin-bottom: 6px;
            font-family: inherit;
        }

        .status-input-area textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            background: #ffffff;
        }

        .btn-save-status {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: background 140ms ease;
        }

        .btn-save-status:hover {
            background: var(--color-primary-hover);
        }

        .right-sidebar {
            position: absolute;
            top: 0;
            left: 100%;
            margin-left: 20px;
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .widget-box {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(14, 0, 40, 0.08);
            border: 1px solid #e0d6ec;
            padding: 16px;
            width: 100%;
            display: block;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .widget-title {
            font-size: 13px;
            font-weight: 700;
            color: #2a1b4a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .capacity-week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            background: #f8f6ff;
            padding: 6px 10px;
            border-radius: 8px;
        }

        .capacity-week-nav button {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #7a1ea2;
            font-weight: bold;
        }

        .capacity-user-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .capacity-user-icon {
            width: 24px;
            height: 24px;
            background: #7a1ea2;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }


        .status-history-item {
            background: #fbf9ff;
            border-left: 3px solid #7a1ea2;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .status-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
            margin-bottom: 4px;
        }

        .status-content {
            font-size: 12px;
            color: #333;
        }
		
		

        .status-textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border: 1px solid #e0d6ec;
            border-radius: 6px;
            font-size: 12px;
            resize: none;
            margin-bottom: 6px;
        }

        .btn-save-status {
            width: 100%;
            background: #7a1ea2;
            color: white;
            border: none;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }
		/* ==================== DASHBOARD MEJORADO ==================== */

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.dashboard-title-section {
    flex: 1;
}

.dashboard-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
}

.dashboard-subtitle {
    font-size: 13px;
    color: #666;
    margin-top: 4px;
}

.dashboard-view {
    display: none !important;
}

.dashboard-view.active {
    display: block !important;
}


.active-filters-badge {
    background: var(--color-primary);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

/* Filtros */
.dashboard-filters-bar {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.filter-group-wide {
    grid-column: span 2;
}

.filter-group-action {
    display: flex;
    justify-content: flex-end;
}

.filter-group label {
    font-size: 11px;
    font-weight: 700;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-input-modern,
.filter-select-modern {
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    transition: all 0.2s;
    font-family: inherit;
}

.filter-input-modern:focus,
.filter-select-modern:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(122, 30, 162, 0.1);
}

.filter-select-modern {
    cursor: pointer;
    height: auto;
    min-height: 42px;
}

.filter-select-modern[multiple] {
    padding: 6px;
}

.filter-select-modern option {
    padding: 8px;
    border-radius: 4px;
    margin: 2px 0;
}

.filter-select-modern option:checked {
    background: var(--color-primary) !important;
    color: white !important;
}


.filter-select-compact {
    padding: 6px 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 13px;
    background: white;
    transition: all 0.2s;
    font-family: inherit;
    cursor: pointer;
    height: auto;
    max-height: 90px;
    overflow-y: auto;
}

.filter-select-compact:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(122, 30, 162, 0.1);
}

.filter-select-compact option {
    padding: 6px;
    border-radius: 4px;
    margin: 2px 0;
}

.filter-select-compact option:checked {
    background: var(--color-primary) !important;
    color: white !important;
}


.date-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-input {
    flex: 1;
    min-width: 0;
}

.date-separator {
    color: var(--color-primary);
    font-size: 16px;
    font-weight: bold;
}

.btn-clear-filters {
    padding: 10px 20px;
    background: #f5f5f5;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #666;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-clear-filters:hover {
    background: #ffebf3;
    border-color: var(--color-primary);
    color: var(--color-primary);
}

/* Contenido */
.dashboard-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: linear-gradient(135deg, #f8f4fb 0%, #fff 100%);
    padding: 6px;
    border-radius: 10px;
    border: 2px solid #f0e6f6;
    text-align: center;
}

.stat-label {
    font-size: 11px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 21px;
    font-weight: 700;
    color: var(--color-primary);
}

/* Tabla */
.dashboard-table-container {
    overflow-x: auto;
    margin-bottom: 24px;
}

.dashboard-table {
    width: 100%;
    border-collapse: collapse;
}

.dashboard-table thead {
    background: #f8f8f8;
    position: sticky;
    top: 0;
    z-index: 10;
}

.dashboard-table th {
    padding: 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e0e0e0;
}

.dashboard-table td {
    padding: 8px 12px;
    font-size: 13px;
    border-bottom: 1px solid #f0f0f0;
}

.dashboard-row {
    cursor: pointer;
    transition: all 0.2s;
}

.dashboard-row:hover {
    background: #f9f9f9;
}

.dash-name {
    color: var(--color-primary);
    font-weight: 600;
}

.dash-num {
    text-align: center;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
}

.dash-num-center {
    text-align: center;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
}


.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
}

.badge-fase {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-baja {
    background: #f1f8e9;
    color: #689f38;
}

.badge-media {
    background: #fff3e0;
    color: #f57c00;
}

.badge-alta {
    background: #ffebee;
    color: #d32f2f;
}

.badge-bajo {
    background: #f1f8e9;
    color: #689f38;
}

.badge-medio {
    background: #fff3e0;
    color: #f57c00;
}

.badge-alto {
    background: #ffebee;
    color: #d32f2f;
}

.badge-status.badge-verde {
    background: #e8f5e9;
    color: #2e7d32;
}

.badge-status.badge-ámbar {
    background: #fff8e1;
    color: #f57f17;
}

.badge-status.badge-rojo {
    background: #ffebee;
    color: #c62828;
}

.progress-bar-container {
    position: relative;
    width: 100%;
    height: 24px;
    background: #f0f0f0;
    border-radius: 12px;
    overflow: hidden;
}

.progress-bar-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #c8a2d8 0%, #dbbfea 100%);
    transition: width 0.3s;
    border-radius: 12px;
}



.progress-bar-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 700;
    color: #333;
    z-index: 1;
}

/* Resumen */
.dashboard-summary {
    background: linear-gradient(135deg, #f8f4fb 0%, #fff 100%);
    padding: 8px 12px;
    border-radius: 10px;
    border: 2px solid #f0e6f6;
}

.summary-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 8px;
    margin-top: 0;
}

.summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
    margin: 0;
}

.summary-item {
    text-align: center;
    padding: 2px 0;
    margin: 0;
}

.summary-label {
    font-size: 10px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    margin-bottom: 2px;
    margin-top: 0;
}

.summary-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
    line-height: 1.2;
}


/* Capacidad */
.dashboard-capacity-section {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.capacity-card {
    max-width: 600px;
}

.capacity-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 4px 0;
}

.capacity-subtitle {
    font-size: 12px;
    color: #666;
    margin: 0 0 20px 0;
}

.capacity-table {
    width: 100%;
    border-collapse: collapse;
}

.capacity-table thead {
    background: #f8f8f8;
}

.capacity-table th,
.capacity-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
}

.capacity-table th {
    font-weight: 700;
    color: #666;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
}

.cap-user {
    font-weight: 600;
}

.user-avatar {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
}

.cap-percent {
    text-align: center;
    font-weight: 700;
    font-size: 14px;
}

.cap-percent-cell {
    text-align: center;
    font-weight: 700;
    font-size: 14px;
}

.cap-center {
    text-align: center;
}

.capacity-table .dash-num-center {
    text-align: center !important;
}

.capacity-table th.dash-num-center {
    text-align: center !important;
}

.capacity-table th:first-child,
.capacity-table td:first-child {
    text-align: center !important;
}



.high-capacity {
    color: #f57f17;
}

.overcapacity {
    color: #c62828;
    font-weight: 900;
}

.capacity-table tbody tr:hover {
    background: #f9f9f9;
}

/* Estilos para días de vacaciones seleccionados */
.calendar-table tbody td.vacation-selected {
    background: linear-gradient(135deg, #7a1ea2 0%, #a030c8 100%) !important;
    color: white;
    font-weight: 700;
    box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5);
    cursor: pointer;
}

.calendar-table tbody td.vacation-selected:hover {
    filter: brightness(1.15);
    box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.8), 
                0 0 12px rgba(122, 30, 162, 0.6);
}

/* Estilos para encabezados ordenables en Dashboard */
.sortable-header {
    cursor: pointer;
    user-select: none;
    transition: background 160ms ease;
    position: relative;
}

.sortable-header:hover {
    background: #e8dff6 !important;
}

.th-sortable {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.sortable-header:hover .th-sortable {
    font-weight: 700;
}

	</style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-logo">WTW</div>
            <div class="sidebar-subtitle">Gestor de iniciativas & dailys</div>
            <button class="btn-new-project" onclick="openNewProjectModal()">✨ Nuevo proyecto</button>

            <div class="sidebar-content">
                <div class="sidebar-title">Activos</div>
                <ul class="sidebar-list" id="projectsListActive"></ul>

                <div class="sidebar-title">Completados</div>
                <ul class="sidebar-list" id="projectsListCompleted"></ul>
            </div>

            <!-- Control de usuario -->
            <div class="user-control">
                <div class="user-icon">👤</div>
                <div class="user-info">
                    <div class="user-name" id="currentUserDisplay">NN</div>
                    <button class="user-change-btn" onclick="changeUser()">Cambiar</button>
                </div>
            </div>
        </div>


        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-left">
                    <h2 id="viewTitle">Daily</h2>
                    <div class="toolbar-caption">Seguimiento semanal y comentarios rápidos por proyecto</div>
                </div>
                <div class="view-toggle">
                    <button class="active" onclick="switchView('daily')">📅 Daily</button>
                    <button onclick="switchView('ficha')">📋 Ficha Proyecto</button>
                    <button onclick="switchView('equipo')">👥 Equipo</button>
					<button onclick="switchView('dashboard')">📈Dashboard</button>
                </div>
            </div>

            <div class="content-area">
                <div class="daily-view active" id="dailyView">
                    <div class="week-navigation">
                        <button class="week-nav-btn" onclick="previousWeek()">← Semana anterior</button>
                        <div class="week-info" id="weekInfo"></div>
                        <button class="week-nav-btn" onclick="nextWeek()">Semana siguiente →</button>
                    </div>

                    <div class="daily-mode-toggle">
                        <button id="btnDailyActivos" class="active"
                            onclick="setDailyViewMode('activos')">Activos</button>
                        <button id="btnDailyCompletados" onclick="setDailyViewMode('completados')">Completados</button>
                    </div>

                    <div id="dailyTableContainer"></div>
                </div>

                <div class="project-ficha" id="fichaView"></div>

                <!-- VISTA EQUIPO -->
                <div class="team-view" id="teamView"></div>
				<div class="dashboard-view" id="dashboardView"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="dailyModal">
        <div class="modal-content">
            <div class="modal-title" id="dailyModalTitle">Nuevo comentario Daily</div>
            <div class="form-group">
                <label>Proyecto</label>
                <select id="commentProjectSelect" onchange="updateAvailableTasks()">
                    <option value="">Selecciona un proyecto...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Responsable</label>
                <select id="commentResponsible">
                    <option value="">Selecciona...</option>
                    <option value="IS">IS</option>
                    <option value="DH">DH</option>
                    <option value="HR">HR</option>
                    <option value="PU">PU</option>
                    <option value="AR">AR</option>
                    <option value="MR">MR</option>
                </select>
            </div>
            <div class="form-group">
                <label>Urgencia</label>
                <select id="commentUrgency">
                    <option value="Normal">Normal</option>
                    <option value="Alta">Alta</option>
                    <option value="Máxima">Máxima</option>
                </select>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="commentIncident">
                    Tiene incidencia
                </label>
            </div>
            <div class="form-group">
                <label>Comentario</label>
                <textarea id="commentText" placeholder="Escribe tu comentario..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveDailyComment()">Guardar</button>
                <button class="btn btn-cancel" onclick="closeDailyModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="commentsListModal">
        <div class="modal-content">
            <div class="modal-title">Comentarios del día</div>
            <div id="commentsListContainer"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="openAddCommentFromList()">Añadir más</button>
                <button class="btn btn-cancel" onclick="closeCommentsListModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content modal-project">
            <div class="modal-title">Crear nuevo proyecto</div>
            <div class="form-group">
                <label>Nombre de la iniciativa</label>
                <input type="text" id="projectName" placeholder="Ej: Automatización de Claims...">
            </div>
            <div class="form-group">
                <label>Fecha inicio</label>
                <input type="date" id="projectStartDate">
            </div>
            <div class="form-group">
                <label>Fecha fin</label>
                <input type="date" id="projectEndDate">
            </div>
            <div class="form-group">
                <label>Fase del proyecto</label>
                <select id="projectPhase">
                    <option value="Idea">Idea</option>
                    <option value="En Progreso">En Progreso</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Cerrado">Cerrado</option>
                </select>
            </div>
            <div class="form-group">
                <label>Stakeholders</label>
                <input type="text" id="projectStakeholders" placeholder="Ej: Juan (Product Owner), María (IT), ...">
            </div>
            <div class="form-group">
                <label>Ahorro (€)</label>
                <input type="number" id="volume" placeholder="Ej: 50000" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Ahorro (FTE)</label>
                <input type="number" id="fte" placeholder="Ej: 1.5" min="0" step="0.1">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveNewProject()">Crear proyecto</button>
                <button class="btn btn-cancel" onclick="closeProjectModal()">Cancelar</button>
            </div>
        </div>
    </div>

	<script>
// Configuración de Supabase (producción)
const SUPABASE_URL = "https://snyvvbwkkqpecfcvvdid.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueXZ2Yndra3FwZWNmY3Z2ZGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjc3MDYsImV4cCI6MjA4NDYwMzcwNn0.szk1Do5oUAEg6zsqBGAIWC43zULtB1rDtmF8O9i2i9s";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Prerrequisitos estándar para todos los proyectos
const STANDARD_PREREQUISITES = [
    "Business Case",
    "Stakeholders",
    "Cálculo de Ahorros",
    "Aprobaciones",
    "Project Plan",
    "Comunicaciones",
    "Traspaso a BAU"
];

	</script>
	<script>
﻿
        // ========== CONFIGURACIÓN PRODUCCIÓN ==========
        
        // =====================================================
        // =========== CONFIGURACIÓN Y VARIABLES GLOBALES ======
        // =====================================================


        // const SUPABASE_URL = "https://snyvvbwkkqpecfcvvdid.supabase.co";
        // const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueXZ2Yndra3FwZWNmY3Z2ZGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjc3MDYsImV4cCI6MjA4NDYwMzcwNn0.szk1Do5oUAEg6zsqBGAIWC43zULtB1rDtmF8O9i2i9s";
        // const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // const STANDARD_PREREQUISITES = [
        //     "Business Case",
        //     "Stakeholders",
        //     "Cálculo de Ahorros",
        //     "Aprobaciones",
        //     "Project Plan",
        //     "Comunicaciones",
        //     "Traspaso a BAU"
        // ];

        let projectStatuses = [];
        let currentUser = null; // valor inicial por defecto


        // =====================================================
        // =============== FUNCIONES COMPARTIDAS ===============
        // (utilidades, helpers, actualización de campos, etc.)
        // =====================================================

        // Estado global para collapse/expand del sidebar
        let sidebarCollapsed = {
            activos: false,
            completados: false
        };

        // Función para escapar HTML y prevenir XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return String(text).replace(/[&<>"']/g, char => map[char]);
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'Verde': return '✅';
                case 'Ámbar': return '⚠️';
                case 'Rojo': return '🚫';
                default: return '✅';
            }
        }
        
        function getStatusText(status) {
    switch (status) {
        case "Verde":
            return "On Time";
        case "Ámbar":
            return "Riesgo";
        case "Rojo":
            return "Bloqueo";
        default:
            return status || "-";
    }
}


        function toggleIndicatorDropdown(event, type) {
            event.stopPropagation();

            // Cerrar todos los dropdowns
            document.querySelectorAll('.indicator-dropdown').forEach(d => d.classList.remove('active'));

            // Abrir el dropdown específico
            const dropdown = document.getElementById(`dropdown-${type}`);
            if (dropdown) {
                dropdown.classList.add('active');
            }

            // Cerrar al hacer clic fuera
            setTimeout(() => {
                document.addEventListener('click', closeAllDropdowns, { once: true });
            }, 10);
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.indicator-dropdown').forEach(d => d.classList.remove('active'));
        }

        async function updateIndicator(event, projectId, field, value) {
            event.stopPropagation();
            closeAllDropdowns();

            // Actualizar en memoria
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
            }

            // Guardar en base de datos
            await updateProjectField(projectId, field, value);

            // Refrescar vistas
            renderFicha();
        }


        const madridHolidays = [
            '2025-01-01', '2025-01-06',
            '2025-04-17', '2025-04-18',
            '2025-05-01', '2025-05-02',
            '2025-07-25', '2025-08-15',
            '2025-10-12', '2025-11-01', '2025-11-09',
            '2025-12-06', '2025-12-08', '2025-12-25',
            '2026-01-01', '2026-01-06',
            '2026-04-02', '2026-04-03',
            '2026-05-01', '2026-05-02',
            '2026-08-15',
            '2026-10-12', '2027-11-02',
            '2026-12-07', '2027-12-08', '2027-12-25',
            '2027-01-01', '2027-01-06',
            '2027-03-25', '2027-03-26',
            '2027-05-01',
            '2027-10-12',
            '2027-11-01',
            '2027-12-06', '2027-12-08', '2027-12-25'
        ];

        let projects = [];
        let dailyComments = [];
        let teamVacations = [];
        let selectedVacationDays = []; // Rastrear días seleccionados para vacaciones
        let currentMonth = new Date();
        const teamMembers = ['IS', 'DH', 'HR', 'PU', 'AR', 'MR']; // Ajusta según tu equipo
        let currentProjectId = null;
        let currentWeekStart = getMonday(new Date());
        let editingCommentId = null;
        let commentsListContext = { projectId: null, dateKey: null };

        let dailyFilters = {
            proyecto: '',
            estado: '',
            fechaInicio: ''
        };

        let dailyViewMode = 'activos';
        let dashboardFilters = {
    proyecto: '',
    fases: [],
    prioridades: [],
    impactos: [],
    estados: [],
    fechaInicioDesde: '',
    fechaInicioHasta: '',
    fechaFinDesde: '',
    fechaFinHasta: ''
};

let dashboardSort = {
    column: null,
    direction: 'asc'
};

let dailySort = {
    column: null,
    direction: 'asc'
};

function setDashboardFilter(field, value) {
  dashboardFilters[field] = value;
  
  // Guardar el elemento activo y su posición del cursor ANTES de re-renderizar
  const activeElement = document.activeElement;
  const isFilterInput = activeElement && activeElement.id === 'dashFilterProyecto';
  let cursorPosition = 0;
  
  if (isFilterInput) {
    cursorPosition = activeElement.selectionStart;
  }
  
  // Re-renderizar
  renderDashboard();
  
  // Restaurar el foco y la posición del cursor DESPUÉS de re-renderizar
  if (isFilterInput) {
    setTimeout(() => {
      const newInput = document.getElementById('dashFilterProyecto');
      if (newInput) {
        newInput.focus();
        newInput.setSelectionRange(cursorPosition, cursorPosition);
      }
    }, 0);
  }
}



// =====================================================
// ====================== DAILY ========================
// (tabla semanal, filtros, comentarios diarios, etc.)
// =====================================================

function setDailyViewMode(mode) {
    dailyViewMode = mode;
    document.getElementById('btnDailyActivos').classList.toggle('active', mode === 'activos');
    document.getElementById('btnDailyCompletados').classList.toggle('active', mode === 'completados');
    renderDaily();
}


        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDates(mondayDate) {
            const dates = [];
            for (let i = 0; i < 5; i++) {
                const date = new Date(mondayDate);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function previousWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderDaily();
        }

        function nextWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderDaily();
        }

        function updateWeekInfo() {
            const dates = getWeekDates(currentWeekStart);
            if (!dates.length) return;
            const startStr = dates[0].toLocaleDateString('es-ES');
            const endStr = dates[dates.length - 1].toLocaleDateString('es-ES');
            document.getElementById('weekInfo').textContent = `${startStr} - ${endStr}`;
        }

        function openNewProjectModal() {
            document.getElementById('projectModal').classList.add('active');
        }

        function closeProjectModal() {
            // Cerrar modal
            const modal = document.getElementById('projectModal');
            if (modal) modal.classList.remove('active');

            // Limpiar campos de forma SEGURA (solo si existen)
            const fields = ['projectName', 'projectStartDate', 'projectEndDate', 'volume', 'fte', 'projectStakeholders', 'projectPhase'];
            fields.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    if (input.type === 'select-one') {
                        input.value = input.options[0]?.value || '';
                    } else {
                        input.value = '';
                    }
                }
            });
        }



        function generateId() {
            return Date.now().toString() + "-" + Math.random().toString(36).slice(2);
        }

        async function saveNewProject() {
            // LEER TODOS LOS CAMPOS (con los IDs exactos de tu modal)
            const nameInput = document.getElementById('projectName');
            const startDateInput = document.getElementById('projectStartDate');
            const endDateInput = document.getElementById('projectEndDate');
            const volumeInput = document.getElementById('volume');
            const fteInput = document.getElementById('fte');
            const phaseInput = document.getElementById('projectPhase');
            const stakeholdersInput = document.getElementById('projectStakeholders');

            // VALIDAR NOMBRE
            const name = nameInput.value.trim();
            if (!name) {
                alert('Por favor, ingresa el nombre del proyecto.');
                return;
            }

            // LEER VALORES
            const startDate = startDateInput.value || null;
            const endDate = endDateInput.value || null;
            const volume = parseFloat(volumeInput.value) || 0;
            const fte = parseFloat(fteInput.value) || 0;
            const phase = phaseInput.value;
            const stakeholders = stakeholdersInput.value.trim();

            // PRERREQUISITOS ESTÁNDAR
            const prerequisites = (typeof STANDARD_PREREQUISITES !== 'undefined' ? STANDARD_PREREQUISITES : []).map(pName => ({
                name: pName,
                done: false,
                na: false
            }));

            // OBJETO PARA SUPABASE
            const projectRow = {
                name: name,
                start_date: startDate,
                end_date: endDate,
                volume: volume,
                fte: fte,
                phase: phase,
                stakeholders: stakeholders,
                status: 'Verde',
                priority: 'Media',
                progress: 0,
                prerequisites: prerequisites
            };

            // console.log("📤 Creando proyecto:", projectRow);

            // GUARDAR EN SUPABASE
            const { data, error } = await supabaseClient
                .from('projects')
                .insert(projectRow)
                .select()
                .single();

            if (error) {
                console.error("❌ Error:", error);
                alert("Error guardando proyecto: " + error.message);
                return;
            }

            // console.log("✅ Proyecto creado:", data);

            // LIMPIAR FORMULARIO (esto evita que queden los valores marcados)
            nameInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            volumeInput.value = '';
            fteInput.value = '';
            stakeholdersInput.value = '';
            phaseInput.value = 'Idea'; // Resetear al valor por defecto

            // RECARGAR DATOS Y ABRIR FICHA
            await loadDataFromSupabase();

            if (data && data.id) {
                currentProjectId = data.id;
                switchView('ficha');
                renderFicha();
            }

            // CERRAR MODAL
            closeProjectModal();
        }





        function renderProjectsList() {
            const listActive = document.getElementById('projectsListActive');
            const listCompleted = document.getElementById('projectsListCompleted');
            
            if (!listActive || !listCompleted) {
                return; // Elementos no existen aún
            }

            // Limpiar y actualizar ACTIVOS
            listActive.innerHTML = '';
            listActive.className = `projects-list ${sidebarCollapsed.activos ? 'collapsed' : 'expanded'}`;
            
            projects.forEach(project => {
                if (project.phase !== 'Cerrado') {
                    const li = document.createElement('li');
                    const isActive = currentProjectId === project.id ? 'active' : '';
                    li.innerHTML = `<button onclick="selectProject('${project.id}')" class="${isActive}">${escapeHtml(project.name)}</button>`;
                    listActive.appendChild(li);
                }
            });

            // Limpiar y actualizar COMPLETADOS
            listCompleted.innerHTML = '';
            listCompleted.className = `projects-list ${sidebarCollapsed.completados ? 'collapsed' : 'expanded'}`;
            
            projects.forEach(project => {
                if (project.phase === 'Cerrado') {
                    const li = document.createElement('li');
                    const isActive = currentProjectId === project.id ? 'active' : '';
                    li.innerHTML = `<button onclick="selectProject('${project.id}')" class="${isActive}">${escapeHtml(project.name)}</button>`;
                    listCompleted.appendChild(li);
                }
            });

            const select = document.getElementById('commentProjectSelect');
            if (select) {
                select.innerHTML = '<option value="">Selecciona un proyecto...</option>';
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            }
        }

        function toggleSidebarSection(section) {
            sidebarCollapsed[section] = !sidebarCollapsed[section];
            
            // Actualizar ícono con el atributo data-collapsed
            const titles = document.querySelectorAll('.sidebar-title');
            const titleIndex = section === 'activos' ? 0 : 1;
            if (titles[titleIndex]) {
                const icon = titles[titleIndex].querySelector('.section-toggle-icon');
                if (icon) {
                    icon.setAttribute('data-collapsed', sidebarCollapsed[section] ? 'true' : 'false');
                }
            }
            
            renderProjectsList();
        }

        function selectProject(projectId) {
            currentProjectId = projectId;

            // Detectar si el proyecto seleccionado es completado
            const selectedProject = projects.find(p => p.id === projectId);
            if (selectedProject) {
                // Si está en vista Daily, cambiar automáticamente el modo según el estado del proyecto
                const isDailyView = document.querySelector('.daily-view.active');
                if (isDailyView) {
                    if (selectedProject.phase === 'Cerrado') {
                        setDailyViewMode('completados');
                    } else {
                        setDailyViewMode('activos');
                    }
                }
            }

            renderProjectsList();

            const currentView = document.querySelector('.daily-view.active') ? 'daily' : 'ficha';
            if (currentView === 'ficha') {
                renderFicha();
            } else {
                renderDaily();
            }
        }


        function formatDateDisplay(isoDate) {
            if (!isoDate) return '';
            const d = new Date(isoDate);
            if (isNaN(d)) return isoDate;
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function renderDaily() {
            // 1. Si no hay proyectos en absoluto (base de datos vacía), mostrar mensaje inicial
            if (!projects.length) {
                document.getElementById('dailyTableContainer').innerHTML = '<div class="empty-state">Crea un proyecto para empezar a usar la daily.</div>';
                return;
            }

            updateWeekInfo();
            const weekDates = getWeekDates(currentWeekStart);

            const estadosUnicos = Array.from(
                new Set(projects.map(p => p.phase || 'Sin fase'))
            ).filter(x => x);

            // Aplicar filtros
            let filteredProjects = projects.filter(p =>
                dailyViewMode === 'activos'
                    ? p.phase !== 'Cerrado'
                    : p.phase === 'Cerrado'
            );

            if (dailyFilters.proyecto && dailyFilters.proyecto.trim()) {
                const txt = dailyFilters.proyecto.trim().toLowerCase();
                filteredProjects = filteredProjects.filter(p =>
                    (p.name || '').toLowerCase().includes(txt)
                );
            }

            if (dailyFilters.estado && dailyFilters.estado.trim()) {
                const estadoFiltro = dailyFilters.estado.trim();
                filteredProjects = filteredProjects.filter(
                    p => (p.phase || 'Sin fase') === estadoFiltro
                );
            }

            if (dailyFilters.fechaInicio) {
  filteredProjects = filteredProjects.filter(p => 
    p.startDate && p.startDate.slice(0, 10) >= dailyFilters.fechaInicio
  );
}


            // <--- CAMBIO 1: ELIMINADO EL BLOQUE QUE RETORNABA EARLY SI NO HABÍA RESULTADOS
            // (Antes aquí había un if (!filteredProjects.length) { ... return; } que borraba la tabla)

            let html = '<table class="daily-table"><thead>';

            const tituloTabla = dailyViewMode === 'activos' ? 'Proyecto (activos)' : 'Proyecto (completados)';
            html += `<tr><th onclick="toggleDailySort('name')" class="sortable-header">${tituloTabla} ${getSortIndicatorDaily('name')}</th><th onclick="toggleDailySort('status')" class="sortable-header">Estado ${getSortIndicatorDaily('status')}</th><th onclick="toggleDailySort('startDate')" class="sortable-header">Fecha inicio ${getSortIndicatorDaily('startDate')}</th>`;

            weekDates.forEach((date) => {
                const dateKey = date.toISOString().slice(0, 10);
                const isToday = dateKey === new Date().toISOString().slice(0, 10);
                const isHoliday = madridHolidays.includes(dateKey);

                const dayNameRaw = date.toLocaleDateString('es-ES', { weekday: 'long' });
                const dayName = dayNameRaw.charAt(0).toUpperCase() + dayNameRaw.slice(1);
                const dateStr = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'numeric' });

                let headerClass = 'day-header';
                if (isToday) {
                    headerClass += ' today-header';
                }
                if (isHoliday) {
                    headerClass += ' holiday-header';
                }

                const holidayBadge = isHoliday ? '<span style="position:absolute;top:4px;right:6px;font-size:9px;color:#d32f2f;font-weight:700;">FESTIVO</span>' : '';

                html += `<th class="${headerClass}" style="position:relative;">${holidayBadge}${dayName}<br>${dateStr}</th>`;
            });

            html += '</tr>';

            // FILA DE FILTROS (Se dibuja siempre)
            html += '<tr class="filter-row">';

            html += '<th><input class="filter-input" type="text" placeholder="Filtrar..." ' +
                'value="' + dailyFilters.proyecto + '" ' +
                'oninput="onFilterChange(\'proyecto\', this.value)"></th>';

            html += '<th><select class="filter-select" onchange="onFilterChange(\'estado\', this.value)">' +
                '<option value="">Todos</option>';
            estadosUnicos.forEach(est => {
                const sel = dailyFilters.estado === est ? 'selected' : '';
                html += '<option value="' + est + '" ' + sel + '>' + est + '</option>';
            });
            html += '</select></th>';

            html += '<th><input class="filter-input" type="date" ' +
                'value="' + dailyFilters.fechaInicio + '" ' +
                'oninput="onFilterChange(\'fechaInicio\', this.value || \'\')"></th>'; // <--- OJO: Asegúrate de manejar el string vacío

            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const usersOnVacation = teamVacations
                    .filter(v => dateKey >= v.start_date && dateKey <= v.end_date)
                    .map(v => v.user_initials)
                    .filter((value, index, self) => self.indexOf(value) === index);

                const vacationBadges = usersOnVacation.map(user =>
                    `<span class="vacation-badge">${user}</span>`
                ).join('');

                html += `<th style="padding: 3px 2px;">${vacationBadges}</th>`;
            });

            html += `</tr>`;
            html += `</thead><tbody>`;

            // <--- CAMBIO 2: MANEJO DE SIN RESULTADOS DENTRO DEL BODY
            if (!filteredProjects.length) {
                // Calculamos colspan: 3 columnas fijas + 5 días de la semana = 8
                const label = dailyViewMode === 'activos' ? 'activos' : 'completados';
                html += `<tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                            No hay proyectos ${label} que cumplan los filtros seleccionados.
                        </td>
                     </tr>`;
            } else {
                // Aplicar ordenamiento
                const sortedProjects = sortDailyProjects(filteredProjects);
                
                // Renderizado normal de filas si hay resultados
                sortedProjects.forEach(project => {
                    const selectedClass = project.id === currentProjectId ? 'selected-row' : '';
                    html += `<tr class="${selectedClass}" onclick="onRowClick('${project.id}')">
                    <td class="project-name-cell" onclick="onProjectNameClick(event, '${project.id}')">${escapeHtml(project.name)}</td>
                    <td>
                        <select class="state-select"
                                onclick="event.stopPropagation()"
                                onchange="updateProjectPhaseFromDaily(event, '${project.id}')">
                            <option value="Idea" ${project.phase === 'Idea' ? 'selected' : ''}>Idea</option>
                            <option value="En Progreso" ${project.phase === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                            <option value="On Hold" ${project.phase === 'On Hold' ? 'selected' : ''}>On Hold</option>
                            <option value="Cerrado" ${project.phase === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                        </select>
                    </td>
                    <td>${formatDateDisplay(project.startDate)}</td>`;

                    weekDates.forEach((date) => {
                        const dayNum = String(date.getDate()).padStart(2, '0');
                        const monthNum = String(date.getMonth() + 1).padStart(2, '0');
                        const dateKey = `${date.getFullYear()}-${monthNum}-${dayNum}`;

                        const cellComments = dailyComments.filter(c =>
                            c.projectId === project.id && c.date === dateKey
                        );
                        const hasCells = cellComments.length > 0;
                        const isHoliday = madridHolidays.includes(dateKey);
                        const isToday = dateKey === new Date().toISOString().slice(0, 10);
                        const baseClass = hasCells ? 'daily-cell has-comment' : 'daily-cell';
                        const holidayClass = isHoliday ? ' holiday-cell' : '';
                        const todayClass = isToday ? ' today-cell' : '';
                        const cellClass = baseClass + holidayClass + todayClass;

                        let previewText = '';
                        let metaText = '';
                        if (hasCells) {
                            const latest = cellComments.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                            const shortText = latest.text.length > 60 ? latest.text.slice(0, 60) + '…' : latest.text;
                            previewText = shortText.replace(/\n/g, ' ');
                            metaText = `${cellComments.length} comentario(s) · ${latest.urgency}${latest.hasIncident ? ' · INCIDENCIA' : ''}`;
                        }

                        html += `<td class="${cellClass}">
                        <div class="daily-cell-content">
                            <div class="daily-cell-preview">${previewText}</div>
                            ${metaText ? `<div class="daily-cell-meta">${metaText}</div>` : ''}
                            <div class="daily-actions">
                                ${hasCells ? `<button class="daily-action-btn" onclick="openCommentsList(event, '${project.id}', '${dateKey}')">Ver</button>` : ''}
                                <button class="daily-action-btn" onclick="openDailyCommentModalFromCell(event, '${project.id}', '${dateKey}')">+</button>
                            </div>
                        </div>
                    </td>`;
                    });

                    html += '</tr>';
                });
            }

            html += '</tbody></table>';
            document.getElementById('dailyTableContainer').innerHTML = html;
        }


        function onRowClick(projectId) {
            currentProjectId = projectId;
            renderProjectsList();
            renderDaily();
        }

        function onProjectNameClick(event, projectId) {
            event.stopPropagation();
            goToFichaFromDaily(projectId);
        }

        function goToFichaFromDaily(projectId) {
            currentProjectId = projectId;
            renderProjectsList();
            switchView('ficha');
        }

        function onFilterChange(field, value) {
  dailyFilters[field] = value;
  
  // Guardar el elemento activo y su posición del cursor ANTES de re-renderizar
  const activeElement = document.activeElement;
  const isFilterInput = activeElement && activeElement.classList.contains('filter-input') && activeElement.type === 'text';
  let cursorPosition = 0;
  
  if (isFilterInput) {
    cursorPosition = activeElement.selectionStart;
  }
  
  // Re-renderizar
  renderDaily();
  
  // Restaurar el foco y la posición del cursor DESPUÉS de re-renderizar
  if (isFilterInput) {
    setTimeout(() => {
      const newInput = document.querySelector('.filter-input[type="text"]');
      if (newInput) {
        newInput.focus();
        newInput.setSelectionRange(cursorPosition, cursorPosition);
      }
    }, 0);
  }
}


       async function updateProjectPhaseFromDaily(event, projectId) {
    event.stopPropagation();
    const newPhase = event.target.value;
    
    // 1. Actualizar en memoria local
    const project = projects.find(p => p.id === projectId);
    if (project) {
        project.phase = newPhase;
    }
    
    // 2. Guardar en base de datos PRIMERO
    await updateProjectField(projectId, "phase", newPhase);
    
    // 3. Cambiar vista según el nuevo estado
    if (newPhase === "Cerrado") {
        dailyViewMode = "completados";
        document.getElementById("btnDailyActivos").classList.remove("active");
        document.getElementById("btnDailyCompletados").classList.add("active");
    } else {
        dailyViewMode = "activos";
        document.getElementById("btnDailyActivos").classList.add("active");
        document.getElementById("btnDailyCompletados").classList.remove("active");
    }
    
    // 4. Refrescar la vista DESPUÉS de guardar
    renderDaily();
}





        function openDailyCommentModalFromCell(event, projectId, dateKey) {
            event.stopPropagation();
            editingCommentId = null;
            openDailyCommentModal(dateKey, projectId);
        }

        function openDailyCommentModal(dateKey, projectIdOverride = null) {
            document.getElementById('dailyModal').classList.add('active');
            document.getElementById('dailyModalTitle').textContent = editingCommentId ? 'Editar comentario Daily' : 'Nuevo comentario Daily';

            const select = document.getElementById('commentProjectSelect');
            select.innerHTML = '<option value="">Selecciona un proyecto...</option>';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                if (p.id === (projectIdOverride || currentProjectId)) opt.selected = true;
                select.appendChild(opt);
            });
            document.getElementById('dailyModal').dataset.dateKey = dateKey;

            if (editingCommentId) {
                const comment = dailyComments.find(c => c.id === editingCommentId);
                if (comment) {
                    document.getElementById('commentProjectSelect').value = comment.projectId;
                    document.getElementById('commentResponsible').value = comment.responsible || '';
                    document.getElementById('commentUrgency').value = comment.urgency;
                    document.getElementById('commentIncident').checked = comment.hasIncident;
                    document.getElementById('commentText').value = comment.text;
                }
            } else {
                document.getElementById('commentResponsible').value = '';
                document.getElementById('commentUrgency').value = 'Normal';
                document.getElementById('commentIncident').checked = false;
                document.getElementById('commentText').value = '';
            }
        }

        function closeDailyModal() {
            document.getElementById('dailyModal').classList.remove('active');
            document.getElementById('commentText').value = '';
            document.getElementById('commentResponsible').value = '';
            document.getElementById('commentUrgency').value = 'Normal';
            document.getElementById('commentIncident').checked = false;
            editingCommentId = null;
        }

        function updateAvailableTasks() {
        }

        async function saveDailyComment() {
            const projectId = document.getElementById('commentProjectSelect').value;
            const responsible = document.getElementById('commentResponsible').value.trim();
            const urgency = document.getElementById('commentUrgency').value;
            const hasIncident = document.getElementById('commentIncident').checked;
            const text = document.getElementById('commentText').value.trim();
            const dateKey = document.getElementById('dailyModal').dataset.dateKey;

            // console.log('Guardando comentario...', { projectId, text, editingCommentId });

            if (!projectId || !text) {
                alert('Por favor, completa los campos obligatorios.');
                return;
            }

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;

            const wasEditing = !!editingCommentId;
            const savedProjectId = projectId;
            const savedDateKey = dateKey;

            if (editingCommentId) {
                // console.log('Actualizando comentario existente:', editingCommentId);
                const { data, error } = await supabaseClient
                    .from('daily_comments')
                    .update({
                        project_id: projectId,
                        date: dateKey,
                        time: timeStr,
                        responsible,
                        urgency,
                        has_incident: hasIncident,
                        text
                    })
                    .eq('id', editingCommentId)
                    .select();

                // console.log('Resultado UPDATE:', { data, error });

                if (error) {
                    console.error(error);
                    alert('Error actualizando comentario');
                    return;
                }

                if (!data || data.length === 0) {
                    console.error('UPDATE no afectó ninguna fila');
                    alert('No se encontró el comentario para actualizar');
                    return;
                }
            } else {
                // console.log('Insertando nuevo comentario');
                const newId = generateId();
                const { error } = await supabaseClient
                    .from('daily_comments')
                    .insert({
                        id: newId,
                        project_id: projectId,
                        date: dateKey,
                        time: timeStr,
                        responsible,
                        urgency,
                        has_incident: hasIncident,
                        user_name: currentUser,
                        text
                    });

                if (error) {
                    console.error(error);
                    alert('Error guardando comentario');
                    return;
                }
            }

            if (urgency === 'Máxima') {
                alert(`⚠️ URGENCIA MÁXIMA\nEnviando notificación a: ${responsible || 'responsable no especificado'}`);
            }

            closeDailyModal();

            // console.log('Recargando datos... wasEditing:', wasEditing);
            await loadDataFromSupabase(true);

            if (wasEditing) {
                // console.log('Reabriendo lista de comentarios para:', savedProjectId, savedDateKey);
                openCommentsList(new Event('click'), savedProjectId, savedDateKey);
            } else {
                renderFicha();
            }
        }





        function openCommentsList(event, projectId, dateKey) {
            event.stopPropagation();
            commentsListContext.projectId = projectId;
            commentsListContext.dateKey = dateKey;

            const comments = dailyComments
                .filter(c => c.projectId === projectId && c.date === dateKey)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const container = document.getElementById('commentsListContainer');
            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 12px;">Sin comentarios para este día.</div>';
            } else {
                let html = `<div class="comments-box">`;
                comments.forEach(c => {
                    const dateObj = new Date(c.date + 'T00:00:00');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const yy = String(dateObj.getFullYear()).slice(-2);
                    const formattedDate = `${dd}/${mm}/${yy}`;

                    const completedClass = c.completed ? 'completed' : '';
                    const completedBadge = c.completed ? '<span class="completion-badge">✓ COMPLETADA</span>' : '';

                    html += `<div class="comment-entry ${completedClass}">
                <div class="comment-checkbox-wrapper">
                    <input type="checkbox" class="comment-checkbox" 
                           ${c.completed ? 'checked' : ''}
                           onclick="toggleCommentCompletion(event, '${c.id}')">
                    <div style="flex: 1;">
                        <div class="comment-header">${formattedDate} [${escapeHtml(c.userName || "ND")}]${completedBadge}</div>
                        <div class="comment-meta">Resp: [${escapeHtml(c.responsible || 'ND')}]</div>
                        <div class="comment-text">${escapeHtml(c.text).replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
                <div class="comment-actions">
                    <button class="comment-action-btn" onclick="editComment('${c.id}')">✏️ Editar</button>
                    <button class="comment-action-btn" onclick="deleteComment('${c.id}')">🗑️ Borrar</button>
                </div>
            </div>`;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            document.getElementById('commentsListModal').classList.add('active');
        }

        // ========== AÑADIR AQUÍ LA NUEVA FUNCIÓN ==========
        async function toggleCommentCompletion(event, commentId) {
            event.stopPropagation();

            const comment = dailyComments.find(c => c.id === commentId);
            if (!comment) return;

            const newCompletedState = !comment.completed;

            const { error } = await supabaseClient
                .from('daily_comments')
                .update({ completed: newCompletedState })
                .eq('id', commentId);

            if (error) {
                console.error(error);
                alert('Error actualizando estado de completado');
                return;
            }

            // Actualizar en memoria y re-renderizar
            comment.completed = newCompletedState;

            const { projectId, dateKey } = commentsListContext;
            if (projectId && dateKey) {
                openCommentsList(new Event('click'), projectId, dateKey);
            }
        }

        async function toggleCommentCompletionFromFicha(event, commentId) {
            event.stopPropagation();

            const comment = dailyComments.find(c => c.id === commentId);
            if (!comment) return;

            const newCompletedState = !comment.completed;

            const { error } = await supabaseClient
                .from('daily_comments')
                .update({ completed: newCompletedState })
                .eq('id', commentId);

            if (error) {
                console.error(error);
                alert('Error actualizando estado de completado');
                return;
            }

            // Actualizar en memoria y re-renderizar la ficha
            comment.completed = newCompletedState;
            renderFicha();
        }

        // ===================================================

        function closeCommentsListModal() {
            document.getElementById('commentsListModal').classList.remove('active');
        }

        function openAddCommentFromList() {
            const { projectId, dateKey } = commentsListContext;
            editingCommentId = null;
            closeCommentsListModal();
            openDailyCommentModal(dateKey, projectId);
        }

        function editComment(commentId) {
            // console.log('Editando comentario:', commentId);
            editingCommentId = commentId;
            const comment = dailyComments.find(c => c.id === commentId);
            if (!comment) {
                console.error('Comentario no encontrado:', commentId);
                return;
            }
            // console.log('Comentario encontrado:', comment);
            closeCommentsListModal();
            openDailyCommentModal(comment.date, comment.projectId);
        }


        async function deleteComment(commentId) {
            const confirmed = confirm('¿Seguro que quieres borrar este comentario?');
            if (!confirmed) return;

            const { projectId, dateKey } = commentsListContext;

            const { error } = await supabaseClient
                .from('daily_comments')
                .delete()
                .eq('id', commentId);

            if (error) {
                console.error(error);
                alert('Error borrando comentario');
                return;
            }

            // Recargar datos SIN cerrar el modal
            await loadDataFromSupabase(true); // skipRender = true

            // Reabrir la lista actualizada
            if (projectId && dateKey) {
                openCommentsList(new Event('click'), projectId, dateKey);
            }
        }



        async function updateProjectField(projectId, field, value) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            let update = {};
            switch (field) {
                case 'name':
                    update.name = value;
                    project.name = value;
                    renderSidebar();
                    break;
                case 'startDate':
                    update.start_date = value || null;
                    project.startDate = value || null;
                    break;
                case 'endDate':
                    update.end_date = value || null;
                    project.endDate = value || null;
                    break;
case "phase":
    update = { phase: value };
    project.phase = value;
    break;

                case 'volume':
                    update.volume = value;
                    project.volume = value;
                    break;
                case 'stakeholders':
                    update.stakeholders = value;
                    project.stakeholders = value;
                    break;
                case 'benefits':
                    update.benefits = value;
                    project.benefits = value;
                    break;
                case 'progress':  // <--- ¡ESTO ES LO QUE FALTABA!
                    update.progress = value;
                    project.progress = value;
                    break;
                case 'prerequisites':
                    update.prerequisites = value;
                    project.prerequisites = value;
                    break;
                case 'priority':
                    update.priority = value;
                    project.priority = value;
                    break;
                case 'impact':
                    update.impact = value;
                    project.impact = value;
                    break;
                case 'status':
                    update.status = value;
                    project.status = value;
                    break;
                case 'fte':
                    const fteVal = parseFloat(value) || 0;
                    update.fte = fteVal;   // <--- ESTO ES CRUCIAL (minúsculas)
                    project.fte = fteVal;  // Actualización local (lo que ves en consola)
                    break;


            }



            // Actualización optimista en UI (ya hecha arriba en 'project')

            // Enviar a Supabase
            const { error } = await supabaseClient
                .from('projects')
                .update(update)
                .eq('id', projectId);

            if (error) {
                console.error('Error updating project field:', error);
                alert('Error al guardar el campo ' + field);
            } else {
                // Opcional: recargar para asegurar sincronía, pero no estrictamente necesario si la optimista funciona
                // await loadProjects(); 
            }
        }


        async function updateProjectProgress(projectId, value) {
    let progress = parseInt(value);
    if (isNaN(progress)) progress = 0;
    if (progress < 0) progress = 0;
    if (progress > 100) progress = 100;

    // Llamar a updateProjectField para guardar
    await updateProjectField(projectId, 'progress', progress);

    // Refrescar visualmente
    renderFicha();
}

function handleProgressWheel(event, projectId, currentValue) {
    event.preventDefault();

    const delta = event.deltaY < 0 ? 5 : -5; // sube/baja de 5 en 5
    let value = parseInt(currentValue, 10);
    if (isNaN(value)) value = 0;

    let newValue = value + delta;
    if (newValue < 0) newValue = 0;
    if (newValue > 100) newValue = 100;

    const input = document.getElementById(`progressInput${projectId}`);
    if (input) {
        input.value = newValue;
    }

    updateProjectProgress(projectId, newValue);
}


// =====================================================
// ================= CAPACIDAD SEMANAL =================
// (capacidad por semana y miembro del equipo)
// =====================================================

let capacityWeekStart = getMonday(new Date());
let projectCapacities = [];

async function loadCapacities() {
    const { data, error } = await supabaseClient
        .from('project_capacities')
        .select('*');

    if (error) {
        console.error(error);
        return;
    }

    projectCapacities = (data || []).map(c => ({
        id: c.id,
        projectId: c.project_id,
        userInitials: c.user_initials,
        weekStart: c.week_start,
        capacityPercent: c.capacity_percent || 0
    }));
}

function renderCapacityWidget() {
    if (!currentProjectId) return '';

    const week1Start = new Date(capacityWeekStart);
    const week2Start = new Date(capacityWeekStart);
    week2Start.setDate(week2Start.getDate() + 7);

    const formatWeek = (date) => {
        const start = new Date(date);
        const end = new Date(date);
        end.setDate(end.getDate() + 4);
        return `${start.getDate()}/${start.getMonth() + 1} - ${end.getDate()}/${end.getMonth() + 1}`;
    };

            let html = `<div class='widget-box' id='capacityWidget'>
        <div class='widget-header'>
            <div class="widget-title">💼 Capacidad Semanal</div>
        </div>
        
        <div class="capacity-week-nav">
            <button onclick="previousCapacityWeek()">◀</button>
            <div class="capacity-week-info">${formatWeek(week1Start)}</div>
            <button onclick="nextCapacityWeek()">▶</button>
        </div>
        
        <div class="capacity-weeks-container">`;

            // Semana actual
            html += renderWeekBlock(week1Start, 'Semana Actual');

            // Semana siguiente
            html += renderWeekBlock(week2Start, 'Semana Siguiente');

            html += `</div></div>`;
            return html;
        }

        function renderWeekBlock(weekStart, label) {
            const weekKey = formatDateKey(weekStart);

            let html = `<div class="capacity-week-block">
        <div class="capacity-week-label">${label}</div>`;

            teamMembers.forEach(user => {
                const existing = projectCapacities.find(c =>
                    c.projectId === currentProjectId &&
                    c.userInitials === user &&
                    c.weekStart === weekKey
                );

                const value = existing ? existing.capacityPercent : 0;

                html += `<div class="capacity-user-row">
            <div class="capacity-user-icon">${user}</div>
            <div class="capacity-input-wrapper">
                <input type="number" 
                       class="capacity-input" 
                       value="${value}" 
                       min="0" 
                       max="100"
                       onchange="updateCapacity('${user}', '${weekKey}', this.value)"
                       placeholder="0">
                <span class="capacity-percent-symbol">%</span>
            </div>
        </div>`;
            });

            html += `</div>`;
            return html;
        }

        async function updateCapacity(userInitials, weekStart, value) {
            let capacity = parseInt(value);
            if (isNaN(capacity)) capacity = 0;
            if (capacity < 0) capacity = 0;
            if (capacity > 100) capacity = 100;

            const existingIndex = projectCapacities.findIndex(c =>
                c.projectId === currentProjectId &&
                c.userInitials === userInitials &&
                c.weekStart === weekStart
            );

            if (existingIndex >= 0) {
                // Actualizar
                projectCapacities[existingIndex].capacityPercent = capacity;

                const { error } = await supabaseClient
                    .from('project_capacities')
                    .update({ capacity_percent: capacity })
                    .eq('id', projectCapacities[existingIndex].id);

                if (error) console.error(error);
            } else {
                // Crear
                const newId = generateId();
                const newCapacity = {
                    id: newId,
                    projectId: currentProjectId,
                    userInitials,
                    weekStart,
                    capacityPercent: capacity
                };

                projectCapacities.push(newCapacity);

                const { error } = await supabaseClient
                    .from('project_capacities')
                    .insert({
                        id: newId,
                        project_id: currentProjectId,
                        user_initials: userInitials,
                        week_start: weekStart,
                        capacity_percent: capacity
                    });

                if (error) console.error(error);
            }

            renderCapacityWidgetInPlace();
        }

        function previousCapacityWeek() {
            capacityWeekStart.setDate(capacityWeekStart.getDate() - 7);
            renderCapacityWidgetInPlace();
        }

        function nextCapacityWeek() {
            capacityWeekStart.setDate(capacityWeekStart.getDate() + 7);
            renderCapacityWidgetInPlace();
        }

        function renderCapacityWidgetInPlace() {
            const existing = document.getElementById('capacityWidget');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                parent.insertAdjacentHTML('afterbegin', renderCapacityWidget());
            }
        }


        function closeCapacityWidget() {
            const widget = document.getElementById('capacityWidget');
            if (widget) widget.remove();
        }




        // 1. Función para cargar estados desde Supabase
        async function loadProjectStatuses() {
    const { data, error } = await supabaseClient
        .from('project_statuses')
        .select()
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error cargando estados:', error);
        return;
    }

    // CONVERSIÓN CORRECTA de snake_case (DB) a camelCase (App)
    projectStatuses = data.map(s => ({
        id: s.id,
        projectId: s.project_id,        // ← De project_id a projectId
        statusText: s.status_text,      // ← De status_text a statusText
        userInitials: s.user_initials,  // ← De user_initials a userInitials
        createdAt: s.created_at         // ← De created_at a createdAt
    }));
}


        // Función para pintar el widget con Historial y Scroll
function renderLastStatusWidget() {
    if (!currentProjectId) return '';

    const allStatuses = (projectStatuses || [])
        .filter(s => s.projectId === currentProjectId)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));  // ← CORREGIDO

    const last = allStatuses[0];
    const older = allStatuses.slice(1);

    let html = `
    <div class="widget-box" style="display:flex; flex-direction:column;">
        <div class="capacity-widget-header">
            <div class="capacity-widget-title">📢 Último Estado</div>
        </div>
        
        <div id="status-display-area">`;

    if (last) {
    const d = new Date(last.createdAt);
    const dateStr = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
    
    html += `
    <div class="current-status-highlight">
        <div class="status-meta" style="color:#7a1ea2; font-weight:bold; margin-bottom:8px; font-size:11px;">
            ${dateStr} - ${last.userInitials}
        </div>
        <div class="status-content" style="font-size:13px; color:#333; line-height:1.4;">${last.statusText}</div>
    </div>`;
    } else {
        html += `<div class="empty-state" style="padding:10px;">No hay estados registrados.</div>`;
    }

    if (older.length > 0) {
        html += `
        <div style="font-size:10px; font-weight:bold; color:#888; margin-bottom:5px; text-transform:uppercase;">
            Historial Anterior
        </div>
        <div class="status-history-container">`;
        
        older.forEach(s => {
            const d = new Date(s.createdAt);  // ← CORREGIDO
            const dateStr = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            
            html += `
            <div class="history-item">
                <div class="status-meta" style="display:flex; justify-content:space-between; font-size:10px; color:#999; margin-bottom:2px;">
                    <span>${dateStr}</span>
                    <span>${s.userInitials}</span>
                </div>
                <div style="color:#555; font-size:11px;">${s.statusText}</div>
            </div>`;
        });
        
        html += `</div>`;
    }

    html += `</div>`;

    html += `
        <div class="status-input-area" style="margin-top:auto; padding-top:10px; border-top:1px solid #eee;">
            <textarea id="newStatusTextWidget" placeholder="Escribe una actualización..."></textarea>
            <button class="btn-save-status" onclick="saveProjectStatus()">Publicar</button>
        </div>
    </div>`;

    return html;
}




        // 3. Función para guardar
        async function saveProjectStatus() {
    // Buscar el textarea con el ID correcto
    const textarea = document.getElementById('newStatusTextWidget');
    const text = textarea ? textarea.value.trim() : '';
    
    if (!text) {
        alert('Por favor escribe algo');
        return;
    }

    const newStatus = {
        id: generateId(),
        project_id: currentProjectId,
        status_text: text,
        user_initials: currentUser || 'US',
        created_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
        .from('project_statuses')
        .insert(newStatus);
        
    if (error) {
        console.error(error);
        alert('Error al guardar');
        return;
    }

    projectStatuses.unshift({
        id: newStatus.id,
        projectId: newStatus.project_id,
        statusText: newStatus.status_text,
        userInitials: newStatus.user_initials,
        createdAt: newStatus.created_at
    });

    if (textarea) textarea.value = '';
    renderFicha();
}





        // =====================================================
        // ================= FICHA DE PROYECTO =================
        // (detalle, progreso, prerrequisitos, comentarios, etc.)
        // =====================================================


        function renderFicha() {
            if (!currentProjectId) {
                document.getElementById('fichaView').innerHTML = `<div class="empty-state">Selecciona un proyecto para ver su ficha.</div>`;
                return;
            }

            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                document.getElementById('fichaView').innerHTML = `<div class="empty-state">Proyecto no encontrado.</div>`;
                return;
            }

            // Calcular progreso
            const progressPercent = project.progress || 0;
            const lightness = 75 - (progressPercent * 0.45);
            const progressColor = `hsl(280, 60%, ${lightness}%)`;

            // --- Render Principal ---
            let html = `<div class="ficha-header">
    <div class="project-meta-row">
        <div class="project-title-section">
            <div class="ficha-title">${escapeHtml(project.name)}
                <span class="project-mini-indicators">
                    <span class="mini-indicator priority-${(project.priority || 'Media').toLowerCase()}" onclick="toggleIndicatorDropdown(event, 'priority')">
                        <span class="mini-label">Prioridad:</span>
                        <span class="mini-value">${project.priority || 'Media'}</span>
                        <div class="indicator-dropdown" id="dropdown-priority">
                            <div class="indicator-option ${project.priority === 'Baja' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'priority', 'Baja')">Baja</div>
                            <div class="indicator-option ${(project.priority || 'Media') === 'Media' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'priority', 'Media')">Media</div>
                            <div class="indicator-option ${project.priority === 'Alta' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'priority', 'Alta')">Alta</div>
                        </div>
                    </span>
                    <span class="mini-indicator impact-${(project.impact || 'Medio').toLowerCase()}" onclick="toggleIndicatorDropdown(event, 'impact')">
                        <span class="mini-label">Impacto:</span>
                        <span class="mini-value">${project.impact || 'Medio'}</span>
                        <div class="indicator-dropdown" id="dropdown-impact">
                            <div class="indicator-option ${project.impact === 'Bajo' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'impact', 'Bajo')">Bajo</div>
                            <div class="indicator-option ${(project.impact || 'Medio') === 'Medio' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'impact', 'Medio')">Medio</div>
                            <div class="indicator-option ${project.impact === 'Alto' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'impact', 'Alto')">Alto</div>
                        </div>
                    </span>
                </span>
            </div>
        </div>
        
        <!-- Círculo de Progreso Final (Centrado y funcional) -->
        <div class="progress-indicator-centered">
            <div class="progress-indicator">
                <svg class="progress-ring" width="60" height="60">
                    <circle class="progress-ring-bg" cx="30" cy="30" r="26" stroke-width="5" />
                    <circle class="progress-ring-progress" cx="30" cy="30" r="26" stroke-width="5"
                            style="stroke-dasharray: 163; stroke-dashoffset: ${163 - (163 * progressPercent / 100)}; stroke: ${progressColor}" />
                </svg>
                
                <div class="progress-text" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    <!-- Input numérico + Símbolo % -->
                    <div style="display: flex; align-items: center; justify-content: center; transform: translateX(-3px);">
                        <input type="number" 
                               class="progress-input" 
                               value="${progressPercent}" 
                               min="0" 
                               max="100" 
                               id="progressInput${project.id}"
                               style="width: 28px; text-align: right; padding: 0; font-size: 14px; border: none; background: transparent; color: var(--color-primary); font-weight: 700;"
                               onchange="updateProjectProgress('${project.id}', this.value)"
                               onwheel="handleProgressWheel(event, '${project.id}', this.value)"
                               onclick="this.select()" />
                        <span style="font-size: 10px; font-weight: 700; color: var(--color-primary); margin-left: 1px;">%</span>
                    </div>
                    <span class="progress-label" style="font-size: 6px; margin-top: 0; transform: translateX(-1px);">AVANCE</span>
                </div>
            </div>
        </div>
        
        <div class="status-badge-container">
            <div class="status-badge status-${(project.status || 'Verde').toLowerCase()}" onclick="toggleIndicatorDropdown(event, 'status')">
                <span class="status-icon">${getStatusIcon(project.status || 'Verde')}</span>
                <span class="status-text">${getStatusText(project.status || "Verde")}</span>
                <div class="indicator-dropdown" id="dropdown-status">
                    <div class="indicator-option ${(project.status || 'Verde') === 'Verde' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'status', 'Verde')">✅ On Time</div>
                    <div class="indicator-option ${project.status === 'Ámbar' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'status', 'Ámbar')">⚠️ Riesgo</div>
                    <div class="indicator-option ${project.status === 'Rojo' ? 'selected' : ''}" onclick="updateIndicator(event, '${project.id}', 'status', 'Rojo')">🚫 Bloqueo</div>
                </div>
            </div>
        </div>
    </div>

    <div class="ficha-row">
        <div class="ficha-field">
            <div class="ficha-label">Fecha inicio</div>
            <div class="ficha-value">
                <input type="date" value="${project.startDate || ''}" onchange="updateProjectField('${project.id}','startDate', this.value)">
            </div>
        </div>
        <div class="ficha-field">
            <div class="ficha-label">Fecha fin</div>
            <div class="ficha-value">
                <input type="date" value="${project.endDate || ''}" onchange="updateProjectField('${project.id}','endDate', this.value)">
            </div>
        </div>
    </div>
    <div class="ficha-row">
        <div class="ficha-field">
            <div class="ficha-label">Fase</div>
            <div class="ficha-value">
                <select onchange="updateProjectField('${project.id}','phase', this.value)">
                    <option value="Idea" ${project.phase === 'Idea' ? 'selected' : ''}>Idea</option>
                    <option value="En Progreso" ${project.phase === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                    <option value="On Hold" ${project.phase === 'On Hold' ? 'selected' : ''}>On Hold</option>
                    <option value="Cerrado" ${project.phase === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                </select>
            </div>
        </div>
        <div class="ficha-field">
            <div class="ficha-label">Ahorro (€)</div>
            <div class="ficha-value">
                <input type="number" 
                       placeholder="0.00" 
                       step="0.01" 
                       min="0"
                       value="${project.volume || ''}" 
                       onchange="updateProjectField('${project.id}','volume', this.value)">
            </div>
        </div>
    </div>
    <div class="ficha-row">
        <div class="ficha-field">
            <div class="ficha-label">Stakeholders</div>
            <div class="ficha-value">
                <input type="text" value="${escapeHtml(project.stakeholders || '')}" onchange="updateProjectField('${project.id}','stakeholders', this.value)">
            </div>
        </div>
        <div class="ficha-field">
        <div class="ficha-field">
            <div class="ficha-label">Ahorro (FTE) </div>
            <div class="ficha-value">
                <input type="number" 
                       placeholder="0.0" 
                       step="0.1" 
                       min="0"
                       value="${project.fte || ''}" 
                       onchange="updateProjectField('${project.id}','fte', this.value)">
            </div>
        </div>
</div>`;

            // Prerrequisitos
            if (project.prerequisites && project.prerequisites.length > 0) {
                html += `<div class="ficha-section">
        <h3 class="section-title">Prerrequisitos y Documentación</h3>
        <div class="checkbox-group-2col">`;

                // 1. Obtenemos lo que tiene guardado el proyecto actualmente
                let currentPrereqs = project.prerequisites || [];

                // 2. Iteramos SIEMPRE sobre la lista estándar (para asegurar el orden y que salgan todos)
                STANDARD_PREREQUISITES.forEach((stdName, index) => {

                    // Buscamos si el proyecto ya tiene datos guardados para este item
                    // Si no los tiene, usamos valores por defecto (false)
                    const savedItem = currentPrereqs.find(p => p.name === stdName) || { done: false, na: false };

                    const isDone = savedItem.done;
                    const isNa = savedItem.na; // Nuevo valor N/A

                    // Clases CSS condicionales
                    let labelClass = '';
                    if (isDone) labelClass = 'completed';
                    else if (isNa) labelClass = 'na-active';

                    // Si es N/A, hacemos la fila un poco transparente
                    const rowStyle = isNa ? 'opacity: 0.6;' : '';
                    // Si es N/A, deshabilitamos el checkbox principal
                    const mainDisabled = isNa ? 'disabled' : '';

                    html += `
        <div class="prereq-item-row" style="${rowStyle}">
            <!-- IZQUIERDA: Checkbox principal + Nombre -->
            <div class="prereq-left">
                <input type="checkbox" 
                       class="prereq-checkbox" 
                       ${isDone ? 'checked' : ''} 
                       ${mainDisabled}
                       onchange="togglePrereqStatus('${project.id}', '${stdName}', 'done', this.checked)">
                
                <span class="prereq-label ${labelClass}">
                    ${stdName}
                </span>
            </div>

            <!-- DERECHA: Opción N/A -->
            <div class="prereq-na-wrapper">
                <label for="na-${index}" style="cursor:pointer; margin-right:4px;">N/A</label>
                <input type="checkbox" 
                       id="na-${index}"
                       class="prereq-na-checkbox"
                       ${isNa ? 'checked' : ''}
                       onchange="togglePrereqStatus('${project.id}', '${stdName}', 'na', this.checked)">
            </div>
        </div>`;
                });

                html += `</div></div>`;

            }

            // --- Comentarios (FORMATO EXACTO DAILY) ---
            // Filtrar comentarios
            const projectComments = dailyComments
                .filter(c => c.projectId === currentProjectId)
                .sort((a, b) => {
                    // Usar createdAt que ya tiene fecha y hora completas
                    return new Date(b.createdAt) - new Date(a.createdAt); // Más reciente primero
                });

            html += `<div class="ficha-section">
        <div class="section-title">
            Comentarios de dailys (${projectComments.length})
            <button style="float:right; font-size:11px; padding:3px 8px; border-radius:999px; border:none; cursor:pointer; background:#f3ecff; color:#2a1b4a;" onclick="goToDailyFromFicha()">📅 Ver en Daily</button>
        </div>`;

            if (projectComments.length === 0) {
                html += `<div class="empty-state">Sin comentarios aún. Añade tu primer comentario desde la vista Daily.</div>`;
            } else {
                html += `<div class="comments-box">`;
                projectComments.forEach(comment => {
                    // Formatear fecha
                    const dateObj = new Date(comment.date + 'T00:00:00');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const yy = String(dateObj.getFullYear()).slice(-2);
                    const formattedDate = `${dd}/${mm}/${yy}`;

                    const responsable = comment.responsible || 'ND';

                    // Obtener iniciales del Autor (quien escribió)
                    // Si no tienes el campo 'userName' guardado, usará 'U' por defecto.
                    const autorName = comment.userName || 'Usuario';
                    const iniciales = autorName.substring(0, 2).toUpperCase();

                    const isCompleted = comment.completed;
                    const completedClass = isCompleted ? 'completed' : '';
                    const completedBadge = isCompleted ? '<span class="completion-badge">COMPLETADO</span>' : '';

                    html += `
            <div class="comment-entry ${completedClass}">
                <div class="comment-header">
                    <div class="comment-checkbox-wrapper">
                         <input type="checkbox" class="comment-checkbox" 
                                ${isCompleted ? 'checked' : ''} 
                                onclick="toggleCommentCompletionFromFicha(event, '${comment.id}')">
                         
                         <!-- Círculo con INICIALES del Autor -->
                         <div style="
                            width: 22px; height: 22px; 
                            background: #e1d6f5; color: #5a3a8a; 
                            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                            font-size: 9px; font-weight: 700; margin-right: 6px; flex-shrink: 0;" 
                            title="Autor: ${autorName}">
                            ${iniciales}
                         </div>

                         <!-- Cabecera con FECHA y RESPONSABLE -->
                         <div style="flex:1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-weight:700; color:var(--color-primary); font-size: 11px;">${formattedDate}</span>
                            
                            <span style="font-size: 10px; color: var(--color-text-secondary); background: rgba(0,0,0,0.05); padding: 1px 6px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.05);">
                                Resp: <strong>${escapeHtml(responsable)}</strong>
                            </span>
                         </div>
                         
                         ${completedBadge}
                    </div>
                </div>
                <div class="comment-text" style="margin-top:6px; padding-left: 58px; font-size: 12px;">
                    ${escapeHtml(comment.text).replace(/\n/g, '<br>')}
                </div>
            </div>`;
                });
                html += `</div>`;
            }

            html += `</div></div>`;

            let rightSidebarHtml = `
    <div class="right-sidebar">
        ${renderCapacityWidget()}
        ${renderLastStatusWidget()}
    </div>
`;

document.getElementById('fichaView').innerHTML = html + rightSidebarHtml;


        }

function renderDashboard() {
    const container = document.getElementById('dashboardView');
    
    container.innerHTML = '';
    
    if (!projects || !projects.length) {
        container.innerHTML = `<div class="empty-state">No hay proyectos. Crea uno para ver el dashboard.</div>`;
        return;
    }

    // Valores únicos para filtros
    const fases = Array.from(new Set(projects.map(p => p.phase).filter(Boolean))).sort();
    const prioridades = Array.from(new Set(projects.map(p => p.priority).filter(Boolean))).sort();
    const impactos = Array.from(new Set(projects.map(p => p.impact).filter(Boolean))).sort();
    const estados = Array.from(new Set(projects.map(p => p.status).filter(Boolean))).sort();

    // Contar filtros activos
    const activeFiltersCount = [
        dashboardFilters.proyecto,
        (dashboardFilters.fases || []).length > 0,
        (dashboardFilters.prioridades || []).length > 0,
        (dashboardFilters.impactos || []).length > 0,
        (dashboardFilters.estados || []).length > 0,
        dashboardFilters.fechaInicioDesde,
        dashboardFilters.fechaInicioHasta,
        dashboardFilters.fechaFinDesde,
        dashboardFilters.fechaFinHasta
    ].filter(Boolean).length;

    // BARRA DE FILTROS MEJORADA
    let html = `
    <div class="dashboard-header">
        ${activeFiltersCount > 0 ? `
        <div class="active-filters-badge">
            ${activeFiltersCount} filtro${activeFiltersCount > 1 ? 's' : ''} activo${activeFiltersCount > 1 ? 's' : ''}
        </div>` : ''}
    </div>

    <div class="dashboard-filters-bar">
        <div class="filter-group">
            <label>🔍 Proyecto</label>
            <input 
                type="text" 
                id="dashFilterProyecto"
                class="filter-input-modern" 
                placeholder="Buscar..." 
                value="${dashboardFilters.proyecto || ''}"
            >
        </div>

                <div class="filter-group">
            <label>📋 Fase</label>
            <select 
                id="dashFilterFase" 
                class="filter-select-compact" 
                multiple 
                size="3"
            >
                ${fases.map(f => `<option value="${f}" ${(dashboardFilters.fases || []).includes(f) ? 'selected' : ''}>${f}</option>`).join('')}
            </select>
        </div>

        <div class="filter-group">
            <label>⚡ Prioridad</label>
            <select 
                id="dashFilterPrioridad" 
                class="filter-select-compact" 
                multiple 
                size="3"
            >
                ${prioridades.map(p => `<option value="${p}" ${(dashboardFilters.prioridades || []).includes(p) ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
        </div>

        <div class="filter-group">
            <label>💥 Impacto</label>
            <select 
                id="dashFilterImpacto" 
                class="filter-select-compact" 
                multiple 
                size="3"
            >
                ${impactos.map(i => `<option value="${i}" ${(dashboardFilters.impactos || []).includes(i) ? 'selected' : ''}>${i}</option>`).join('')}
            </select>
        </div>

        <div class="filter-group">
            <label>🚦 Estado</label>
            <select 
                id="dashFilterEstado" 
                class="filter-select-compact" 
                multiple 
                size="3"
            >
                ${estados.map(e => `<option value="${e}" ${(dashboardFilters.estados || []).includes(e) ? 'selected' : ''}>${e}</option>`).join('')}
            </select>
        </div>


        <div class="filter-group filter-group-wide">
            <label>📅 Rango Fecha Inicio</label>
            <div class="date-range">
                <input 
                    type="date" 
                    id="dashFilterFechaInicioDesde"
                    class="filter-input-modern date-input" 
                    value="${dashboardFilters.fechaInicioDesde || ''}"
                >
                <span class="date-separator">→</span>
                <input 
                    type="date" 
                    id="dashFilterFechaInicioHasta"
                    class="filter-input-modern date-input" 
                    value="${dashboardFilters.fechaInicioHasta || ''}"
                >
            </div>
        </div>

        <div class="filter-group filter-group-wide">
            <label>📅 Rango Fecha Fin</label>
            <div class="date-range">
                <input 
                    type="date" 
                    id="dashFilterFechaFinDesde"
                    class="filter-input-modern date-input" 
                    value="${dashboardFilters.fechaFinDesde || ''}"
                >
                <span class="date-separator">→</span>
                <input 
                    type="date" 
                    id="dashFilterFechaFinHasta"
                    class="filter-input-modern date-input" 
                    value="${dashboardFilters.fechaFinHasta || ''}"
                >
            </div>
        </div>

        <div class="filter-group filter-group-action">
            <label>&nbsp;</label>
            <button class="btn-clear-filters" onclick="clearDashboardFilters()">
                🗑️ Limpiar filtros
            </button>
        </div>
    </div>
    `;

    // Aplicar filtros
    const filteredProjects = projects.filter(p => {
        if (dashboardFilters.proyecto) {
            const txt = dashboardFilters.proyecto.toLowerCase();
            const name = (p.name || '').toLowerCase();
            if (!name.includes(txt)) return false;
        }

        if (dashboardFilters.fases && dashboardFilters.fases.length > 0) {
            if (!dashboardFilters.fases.includes(p.phase)) return false;
        }

        if (dashboardFilters.prioridades && dashboardFilters.prioridades.length > 0) {
    if (!dashboardFilters.prioridades.includes(p.priority)) return false;
}

        if (dashboardFilters.impactos && dashboardFilters.impactos.length > 0) {
            if (!dashboardFilters.impactos.includes(p.impact)) return false;
        }

        if (dashboardFilters.estados && dashboardFilters.estados.length > 0) {
            if (!dashboardFilters.estados.includes(p.status)) return false;
        }

        if (dashboardFilters.fechaInicioDesde) {
            if (!p.startDate || p.startDate < dashboardFilters.fechaInicioDesde) return false;
        }

        if (dashboardFilters.fechaInicioHasta) {
            if (!p.startDate || p.startDate > dashboardFilters.fechaInicioHasta) return false;
        }

        if (dashboardFilters.fechaFinDesde) {
            if (!p.endDate || p.endDate < dashboardFilters.fechaFinDesde) return false;
        }

        if (dashboardFilters.fechaFinHasta) {
            if (!p.endDate || p.endDate > dashboardFilters.fechaFinHasta) return false;
        }

        return true;
    });

    let totalVolume = 0;
    let totalFte = 0;

    // Tabla de proyectos
    html += `
    <div class="dashboard-content">
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-label">Proyectos</div>
                <div class="stat-value">${filteredProjects.length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Activos</div>
                <div class="stat-value">${filteredProjects.filter(p => p.phase !== 'Cerrado').length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completados</div>
                <div class="stat-value">${filteredProjects.filter(p => p.phase === 'Cerrado').length}</div>
            </div>
        </div>

        <div class="dashboard-table-container">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th onclick="toggleDashboardSort('name')" class="sortable-header">Proyecto ${getSortIndicator('name')}</th>
                        <th onclick="toggleDashboardSort('startDate')" class="sortable-header">Inicio ${getSortIndicator('startDate')}</th>
                        <th onclick="toggleDashboardSort('endDate')" class="sortable-header">Fin ${getSortIndicator('endDate')}</th>
                        <th onclick="toggleDashboardSort('phase')" class="sortable-header">Fase ${getSortIndicator('phase')}</th>
                        <th onclick="toggleDashboardSort('priority')" class="sortable-header">Prioridad ${getSortIndicator('priority')}</th>
                        <th onclick="toggleDashboardSort('impact')" class="sortable-header">Impacto ${getSortIndicator('impact')}</th>
                        <th onclick="toggleDashboardSort('status')" class="sortable-header">Estado ${getSortIndicator('status')}</th>
                        <th onclick="toggleDashboardSort('progress')" class="sortable-header">Avance ${getSortIndicator('progress')}</th>
                        <th onclick="toggleDashboardSort('volume')" class="sortable-header">Ahorro € ${getSortIndicator('volume')}</th>
                        <th onclick="toggleDashboardSort('fte')" class="sortable-header">Ahorro FTE ${getSortIndicator('fte')}</th>
                    </tr>
                </thead>
                <tbody>`;

    // Aplicar ordenamiento
    const sortedProjects = sortDashboardProjects(filteredProjects);

    sortedProjects.forEach(p => {
        const start = formatDateDisplay(p.startDate);
        const end = formatDateDisplay(p.endDate);
        const progress = isNaN(parseInt(p.progress, 10)) ? 0 : parseInt(p.progress, 10);
        const volume = Number(p.volume) || 0;
        const fte = Number(p.fte) || 0;
        
        totalVolume += volume;
        totalFte += fte;

        html += `
        <tr class="dashboard-row" onclick="selectProject('${p.id}')">
            <td class="dash-name">${escapeHtml(p.name || 'Sin nombre')}</td>
            <td>${start || '-'}</td>
            <td>${end || '-'}</td>
            <td><span class="badge badge-fase">${p.phase || '-'}</span></td>
            <td><span class="badge badge-${(p.priority || 'Media').toLowerCase()}">${p.priority || '-'}</span></td>
            <td><span class="badge badge-${(p.impact || 'Medio').toLowerCase()}">${p.impact || '-'}</span></td>
            <td><span class="badge badge-status badge-${(p.status || 'Verde').toLowerCase()}">${p.status || '-'}</span></td>
            <td>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    <span class="progress-bar-text">${progress}%</span>
                </div>
            </td>
            <td class="dash-num-center">${volume.toLocaleString('es-ES')}</td>
<td class="dash-num-center">${fte.toLocaleString('es-ES', { minimumFractionDigits: 1 })}</td>
        </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>

        <div class="dashboard-summary">
            <div class="summary-title">Totales</div>
            <div class="summary-row">
                <div class="summary-item">
                    <div class="summary-label">Ahorro Total €</div>
                    <div class="summary-value">${totalVolume.toLocaleString('es-ES')} €</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Ahorro Total FTE</div>
                    <div class="summary-value">${totalFte.toLocaleString('es-ES', { minimumFractionDigits: 1 })}</div>
                </div>
            </div>
        </div>
    </div>`;

    // Widget de dedicación
    const week1Start = new Date(capacityWeekStart);
    const week2Start = new Date(capacityWeekStart);
    week2Start.setDate(week2Start.getDate() + 7);

    const week1Key = formatDateKey(week1Start);
    const week2Key = formatDateKey(week2Start);

    html += `
    <div class="dashboard-capacity-section">
        <div class="capacity-card">
            <h3 class="capacity-title">Dedicación Semanal del Equipo</h3>
            <p class="capacity-subtitle">Suma de dedicación en todos los proyectos activos</p>
            <table class="capacity-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th class="dash-num-center">Semana Actual</th>
                        <th class="dash-num-center">Próxima Semana</th>
                    </tr>
                </thead>
                <tbody>`;

    teamMembers.forEach(user => {
        const capsWeek1 = projectCapacities.filter(c =>
            c.userInitials === user && c.weekStart === week1Key
        );
        const capsWeek2 = projectCapacities.filter(c =>
            c.userInitials === user && c.weekStart === week2Key
        );

        const percent1 = capsWeek1.reduce((sum, c) => sum + (c.capacityPercent || 0), 0);
        const percent2 = capsWeek2.reduce((sum, c) => sum + (c.capacityPercent || 0), 0);

        const colorClass1 = percent1 > 100 ? 'overcapacity' : percent1 >= 80 ? 'high-capacity' : '';
        const colorClass2 = percent2 > 100 ? 'overcapacity' : percent2 >= 80 ? 'high-capacity' : '';

        html += `
                    <tr>
                        <td class="cap-user"><div class="user-avatar">${user}</div></td>
                        <td class="cap-percent dash-num-center ${colorClass1}">${percent1}%</td>
                        <td class="cap-percent dash-num-center ${colorClass2}">${percent2}%</td>
                    </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    </div>`;

    container.innerHTML = html;

    // Event listeners
    setTimeout(() => {
  // Filtro de texto - CON PRESERVACIÓN DE CURSOR
  const proyectoInput = document.getElementById('dashFilterProyecto');
  if (proyectoInput) {
    proyectoInput.addEventListener('input', (e) => {
      const cursorPosition = e.target.selectionStart;
      dashboardFilters.proyecto = e.target.value;
      renderDashboard();
      
      // Restaurar cursor después del re-render
      setTimeout(() => {
        const newInput = document.getElementById('dashFilterProyecto');
        if (newInput) {
          newInput.focus();
          newInput.setSelectionRange(cursorPosition, cursorPosition);
        }
      }, 0);
    });
  }
  
  ['dashFilterFase', 'dashFilterPrioridad', 'dashFilterImpacto', 'dashFilterEstado'].forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.addEventListener('change', () => {
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);
        const keyMap = {
          'dashFilterFase': 'fases',
          'dashFilterPrioridad': 'prioridades',
          'dashFilterImpacto': 'impactos',
          'dashFilterEstado': 'estados'
        };
        dashboardFilters[keyMap[id]] = selected;
        renderDashboard();
      });
    }
  });
  
  ['fechaInicioDesde', 'fechaInicioHasta', 'fechaFinDesde', 'fechaFinHasta'].forEach(key => {
    const input = document.getElementById(`dashFilter${key.charAt(0).toUpperCase() + key.slice(1)}`);
    if (input) {
      input.addEventListener('change', (e) => {
        dashboardFilters[key] = e.target.value;
        renderDashboard();
      });
    }
  });
}, 0);

}



function clearDashboardFilters() {
    dashboardFilters = {
        proyecto: '',
        fases: [],
        prioridades: [],
        impactos: [],
        estados: [],
        fechaInicioDesde: '',
        fechaInicioHasta: '',
        fechaFinDesde: '',
        fechaFinHasta: ''
    };
    renderDashboard();
}

function toggleDashboardSort(column) {
    if (dashboardSort.column === column) {
        // Si es la misma columna, invertir la dirección
        dashboardSort.direction = dashboardSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        // Si es una columna diferente, establecer orden ascendente
        dashboardSort.column = column;
        dashboardSort.direction = 'asc';
    }
    renderDashboard();
}

function getSortIndicator(column) {
    if (dashboardSort.column !== column) return '';
    return dashboardSort.direction === 'asc' ? '▲' : '▼';
}

function sortDashboardProjects(projects) {
    if (!dashboardSort.column) return projects;
    
    const sorted = [...projects].sort((a, b) => {
        let aVal, bVal;
        
        switch(dashboardSort.column) {
            case 'name':
                aVal = (a.name || '').toLowerCase();
                bVal = (b.name || '').toLowerCase();
                break;
            case 'startDate':
                aVal = a.startDate || '';
                bVal = b.startDate || '';
                break;
            case 'endDate':
                aVal = a.endDate || '';
                bVal = b.endDate || '';
                break;
            case 'phase':
                aVal = (a.phase || '').toLowerCase();
                bVal = (b.phase || '').toLowerCase();
                break;
            case 'priority':
                const priorityOrder = { 'Alta': 3, 'Media': 2, 'Baja': 1 };
                aVal = priorityOrder[a.priority] || 0;
                bVal = priorityOrder[b.priority] || 0;
                break;
            case 'impact':
                const impactOrder = { 'Alto': 3, 'Medio': 2, 'Bajo': 1 };
                aVal = impactOrder[a.impact] || 0;
                bVal = impactOrder[b.impact] || 0;
                break;
            case 'status':
                const statusOrder = { 'Rojo': 3, 'Ámbar': 2, 'Verde': 1 };
                aVal = statusOrder[a.status] || 0;
                bVal = statusOrder[b.status] || 0;
                break;
            case 'progress':
                aVal = parseInt(a.progress, 10) || 0;
                bVal = parseInt(b.progress, 10) || 0;
                break;
            case 'volume':
                aVal = Number(a.volume) || 0;
                bVal = Number(b.volume) || 0;
                break;
            case 'fte':
                aVal = Number(a.fte) || 0;
                bVal = Number(b.fte) || 0;
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) {
            return dashboardSort.direction === 'asc' ? -1 : 1;
        }
        if (aVal > bVal) {
            return dashboardSort.direction === 'asc' ? 1 : -1;
        }
        return 0;
    });
    
    return sorted;
}

function toggleDailySort(column) {
    if (dailySort.column === column) {
        // Si es la misma columna, invertir la dirección
        dailySort.direction = dailySort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        // Si es una columna diferente, establecer orden ascendente
        dailySort.column = column;
        dailySort.direction = 'asc';
    }
    renderDaily();
}

function getSortIndicatorDaily(column) {
    if (dailySort.column !== column) return '';
    return dailySort.direction === 'asc' ? '▲' : '▼';
}

function sortDailyProjects(projects) {
    if (!dailySort.column) return projects;
    
    const sorted = [...projects].sort((a, b) => {
        let aVal, bVal;
        
        switch(dailySort.column) {
            case 'name':
                aVal = (a.name || '').toLowerCase();
                bVal = (b.name || '').toLowerCase();
                break;
            case 'status':
                const phaseOrder = { 'Idea': 1, 'En Progreso': 2, 'On Hold': 3, 'Cerrado': 4 };
                aVal = phaseOrder[a.phase] || 0;
                bVal = phaseOrder[b.phase] || 0;
                break;
            case 'startDate':
                aVal = a.startDate || '';
                bVal = b.startDate || '';
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) {
            return dailySort.direction === 'asc' ? -1 : 1;
        }
        if (aVal > bVal) {
            return dailySort.direction === 'asc' ? 1 : -1;
        }
        return 0;
    });
    
    return sorted;
}

        function goToDailyFromFicha() {
            if (!currentProjectId) return;
            switchView('daily');
        }

        function togglePrerequisite(projectId, index) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                // 1. Actualizar en memoria
                project.prerequisites[index].completed = !project.prerequisites[index].completed;

                // 2. Re-renderizar la ficha para ver el cambio inmediatamente
                renderFicha();

                // 3. Guardar en Supabase
                updateProjectField(projectId, 'prerequisites', project.prerequisites);
            }
        }

        async function togglePrereqStatus(projectId, prereqName, type, isChecked) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            // Aseguramos que existe el array
            if (!Array.isArray(project.prerequisites)) {
                project.prerequisites = [];
            }

            // Buscamos el índice de este prerrequisito en los datos del proyecto
            let itemIndex = project.prerequisites.findIndex(p => p.name === prereqName);

            // Si no existe (porque es un proyecto viejo o nuevo campo), lo añadimos
            if (itemIndex === -1) {
                project.prerequisites.push({
                    name: prereqName,
                    done: false,
                    na: false
                });
                itemIndex = project.prerequisites.length - 1;
            }

            // LÓGICA DE ACTUALIZACIÓN
            if (type === 'done') {
                // Si marcamos "Hecho", guardamos el valor
                project.prerequisites[itemIndex].done = isChecked;

                // (Opcional) Si marcas Hecho, podrías desmarcar N/A si quisieras:
                // if(isChecked) project.prerequisites[itemIndex].na = false;

            } else if (type === 'na') {
                // Si marcamos "N/A"
                project.prerequisites[itemIndex].na = isChecked;

                // Si activamos N/A, desactivamos "Hecho" automáticamente
                if (isChecked) {
                    project.prerequisites[itemIndex].done = false;
                }
            }

            // 1. Actualizamos la vista inmediatamente para que el usuario vea el cambio
            renderFicha();

            // 2. Guardamos en Supabase silenciosamente
            await updateProjectField(projectId, 'prerequisites', project.prerequisites);
        }



        // =====================================================
        // =========== NAVEGACIÓN E INICIALIZACIÓN APP =========
        // (cambio de vistas, carga inicial, tiempo real, etc.)
        // =====================================================



        function switchView(view) {
            // 1. Referencias a los contenedores
            const dailyView = document.querySelector('.daily-view');
            const fichaView = document.querySelector('.project-ficha');
            const teamView = document.querySelector('.team-view');
            const dashboardView = document.querySelector('.dashboard-view');

            // 2. Ocultar TODO visualmente
            dailyView.classList.remove('active');
            fichaView.classList.remove('active');
            teamView.classList.remove('active');
            dashboardView.classList.remove('active');

            // 3. Quitar clase active de botones
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));

            // 4. Lógica de activación y LIMPIEZA
            if (view === 'daily') {
                dailyView.classList.add('active');
                document.querySelector('.view-toggle button:nth-child(1)').classList.add('active');
                document.getElementById('viewTitle').textContent = 'Daily';

                // Limpiar la vista de equipo para evitar duplicados fantasma
                teamView.innerHTML = '';

                renderDaily();
            } else if (view === 'ficha') {
                fichaView.classList.add('active');
                document.querySelector('.view-toggle button:nth-child(2)').classList.add('active');
                document.getElementById('viewTitle').textContent = 'Ficha Proyecto';

                // Limpiar la vista de equipo
                teamView.innerHTML = '';

                renderFicha();
            } else if (view === 'equipo') {
                teamView.classList.add('active');
                document.querySelector('.view-toggle button:nth-child(3)').classList.add('active');
                document.getElementById('viewTitle').textContent = 'Calendario de Equipo';
                renderTeamView();
            } else if (view === 'dashboard') {          // <-- AQUÍ
                dashboardView.classList.add('active');
                document
                  .querySelector('.view-toggle button:nth-child(4)')
                  .classList.add('active');
                document.getElementById('viewTitle').textContent = 'Dashboard Proyectos';
                renderDashboard();            
            
            }
        }



        async function loadDataFromSupabase(skipRender = false) {
            await loadCapacities();
            await loadProjectStatuses();
            const { data: projData, error: projError } = await supabaseClient
                .from('projects')
                .select('*')
                .order('created_at', { ascending: true });

            if (projError) {
                console.error(projError);
                alert('Error cargando proyectos');
                return;
            }

            const { data: comData, error: comError } = await supabaseClient
                .from('daily_comments')
                .select('*')
                .order('created_at', { ascending: true });

            if (comError) {
                console.error(comError);
                alert('Error cargando comentarios');
                return;
            }

            projects = (projData || []).map(p => ({
                id: p.id,
                name: p.name || '(Sin nombre)',
                startDate: p.start_date || null,
                endDate: p.end_date || null,
                benefits: p.benefits || "",
                phase: p.phase || "Idea",
                stakeholders: p.stakeholders || "",
                volume: p.volume || "",
                prerequisites: p.prerequisites || [],
                priority: p.priority || "Media",
                impact: p.impact || "Medio",
                status: p.status || "Verde",
                progress: p.progress || 0,
                fte: p.fte,
                createdAt: p.created_at
            }));




            dailyComments = (comData || []).map(c => ({
                id: c.id,
                projectId: c.project_id,
                date: c.date,
                time: c.time,
                responsible: c.responsible,
                urgency: c.urgency || 'Normal',
                hasIncident: !!c.has_incident,
                text: c.text || '',
                completed: !!c.completed,
                userName: c.user_name || 'US',
                createdAt: c.created_at
            }));


            renderProjectsList();
            if (projects.length > 0 && !currentProjectId) {
                currentProjectId = projects[0].id;
            }
            updateWeekInfo();

            // Solo renderizar si no se especifica skipRender
            if (!skipRender) {
    renderDaily();
    renderFicha();  // ← AÑADE ESTA LÍNEA
}
        }



        let projectsChannel = supabaseClient.channel('projects-changes');
        let commentsChannel = supabaseClient.channel('comments-changes');

        projectsChannel
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'projects' },
                async (payload) => {
                    // console.log('Proyecto actualizado:', payload.new);
                    await loadDataFromSupabase();
                }
            )
            .subscribe();

        commentsChannel
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'daily_comments' },
                async (payload) => {
                    // console.log('Comentario nuevo/editado:', payload.new);
                    await loadDataFromSupabase();
                }
            )
            .subscribe();


        // =====================================================
        // =================== VISTA DE EQUIPO =================
        // (calendario, vacaciones, resúmenes de equipo, etc.)
        // =====================================================


        function renderTeamView() {
            const container = document.getElementById('teamView');

            // Header con navegación de mes
            const monthName = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            let html = `
    <div class="team-header">
        <div class="month-navigation">
            <button class="month-nav-btn" onclick="previousMonth()">← Mes anterior</button>
            <div class="current-month">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</div>
            <button class="month-nav-btn" onclick="nextMonth()">Mes siguiente →</button>
        </div>
        <button class="month-nav-btn" onclick="openVacationModal()">➕ Añadir vacaciones</button>
    </div>
`;


            // Calendario
            html += renderMonthCalendar();

            // NUEVA SECCIÓN: Resumen de vacaciones
            html += renderVacationSummary();

            // Estadísticas (las del usuario actual, puedes quitarlas si quieres)
            // html += renderTeamStats(); // <-- Comenta o borra esta línea si no la quieres

            container.innerHTML = html;
        }


        function renderMonthCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            // Generar calendario para varios meses consecutivos
            const numberOfMonths = 12; // <--- CAMBIA ESTE NÚMERO PARA MÁS O MENOS MESES
            const months = [];

            for (let i = 0; i < numberOfMonths; i++) {
                const targetMonth = month + i;
                const targetYear = year + Math.floor(targetMonth / 12);
                const adjustedMonth = targetMonth % 12;

                months.push({
                    year: targetYear,
                    month: adjustedMonth
                });
            }

            let html = `<div class="calendar-scroll-container"><table class="calendar-table">`;

            // ===== THEAD: HEADERS DE MESES =====
            html += `<thead><tr>`;
            html += `<th class="name-column">Miembro</th>`;

            months.forEach(m => {
                const daysInMonth = new Date(m.year, m.month + 1, 0).getDate();
                const monthName = new Date(m.year, m.month, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                html += `<th class="month-header" colspan="${daysInMonth}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</th>`;
            });
            html += `</tr>`;

            // ===== THEAD: HEADERS DE DÍAS =====
            html += `<tr><th class="name-column"></th>`;

            months.forEach((m, monthIndex) => {
                const daysInMonth = new Date(m.year, m.month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(m.year, m.month, day);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const dayName = date.toLocaleDateString('es-ES', { weekday: 'narrow' }).toUpperCase();
                    const weekendClass = isWeekend ? ' weekend-header' : '';
                    const separatorClass = (day === 1 && monthIndex > 0) ? ' month-separator' : '';
                    html += `<th class="${weekendClass}${separatorClass}" title="${date.toLocaleDateString('es-ES')}">${dayName}<br>${day}</th>`;
                }
            });
            html += `</tr></thead>`;

            // ===== TBODY: FILAS DE MIEMBROS =====
            html += `<tbody>`;

            teamMembers.forEach(member => {
                html += `<tr>`;
                html += `<td class="name-column">${member}</td>`;

                months.forEach((m, monthIndex) => {
                    const daysInMonth = new Date(m.year, m.month + 1, 0).getDate();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(m.year, m.month, day);
                        const dateKey = formatDateKey(date);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isHoliday = madridHolidays.includes(dateKey);

                        // Check if user has vacation this day
                        const vacation = teamVacations.find(v =>
                            v.user_initials === member &&
                            dateKey >= v.start_date &&
                            dateKey <= v.end_date
                        );

                        let cellClass = '';
                        let cellContent = '';

                        if (isWeekend) cellClass += ' weekend';
                        if (isHoliday) cellClass += ' holiday';
                        if (day === 1 && monthIndex > 0) cellClass += ' month-separator';

                        // Verificar si este día está seleccionado
                        const isSelected = selectedVacationDays.some(
                            d => d.member === member && d.dateKey === dateKey
                        );
                        if (isSelected) cellClass += ' vacation-selected';

                        if (vacation) {
                            if (vacation.vacation_type === 'current_year') {
                                cellClass += ' vacation-current-year';
                            } else if (vacation.vacation_type === 'previous_year') {
                                cellClass += ' vacation-previous-year';
                            } else if (vacation.vacation_type === 'willis_choice') {
                                cellClass += ' vacation-willis-choice';
                            }
                            cellContent = Number(vacation.days_count) % 1 === 0 ? Number(vacation.days_count) : Number(vacation.days_count).toFixed(1);
                        }

                        html += `<td class="${cellClass}" onclick="toggleVacation('${member}', '${dateKey}', event)" title="${member} - ${dateKey}">${cellContent}</td>`;
                    }
                });

                html += `</tr>`;
            });

            html += `</tbody></table></div>`;

            // AQUÍ ES DONDE ESTABA LA LEYENDA, YA BORRADA.

            return html;
        }


        function renderTeamStats() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const currentYear = new Date().getFullYear();

            // Obtener usuario actual, fallback a 'NN' si no está definido
            const userToFilter = typeof currentUser !== 'undefined' ? currentUser : 'NN';

            // Vacaciones este mes (solo del usuario actual)
            const myVacationsThisMonth = teamVacations
                .filter(v =>
                    v.user_initials === userToFilter &&
                    v.start_date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)
                )
                .reduce((sum, v) => sum + (Number(v.days_count) || 0), 0);

            // Total vacaciones año actual
            const myVacationsCurrentYear = teamVacations
                .filter(v =>
                    v.user_initials === userToFilter &&
                    (v.vacation_year === currentYear || (!v.vacation_year && new Date(v.start_date).getFullYear() === currentYear)) &&
                    v.vacation_type === 'current_year'
                )
                .reduce((sum, v) => sum + (Number(v.days_count) || 0), 0);

            // Total Willis Choice
            const myWillisChoice = teamVacations
                .filter(v =>
                    v.user_initials === userToFilter &&
                    v.vacation_type === 'willis_choice'
                )
                .reduce((sum, v) => sum + (Number(v.days_count) || 0), 0);

            return `
        <div class="team-stats">
            <div class="stat-card">
                <div class="stat-label">Vacaciones este mes (${userToFilter})</div>
                <div class="stat-value">${myVacationsThisMonth.toFixed(1)} días</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total vacaciones ${currentYear}</div>
                <div class="stat-value">${myVacationsCurrentYear.toFixed(1)} días</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Willis Choice</div>
                <div class="stat-value">${myWillisChoice.toFixed(1)} días</div>
            </div>
        </div>
    `;
        }

        function renderVacationSummary() {
            const currentYear = new Date().getFullYear();

            // Calcular totales por usuario
            const summary = teamMembers.map(member => {
                // Vacaciones año actual
                const currentYearDays = teamVacations
                    .filter(v =>
                        v.user_initials === member &&
                        v.vacation_type === 'current_year' &&
                        (v.vacation_year === currentYear || new Date(v.start_date).getFullYear() === currentYear)
                    )
                    .reduce((sum, v) => sum + (Number(v.days_count) || 0), 0);

                // Willis Choice año actual
                const willisChoiceDays = teamVacations
                    .filter(v =>
                        v.user_initials === member &&
                        v.vacation_type === 'willis_choice' &&
                        new Date(v.start_date).getFullYear() === currentYear
                    )
                    .reduce((sum, v) => sum + (Number(v.days_count) || 0), 0);

                return {
                    member,
                    currentYearDays,
                    willisChoiceDays,
                    total: currentYearDays + willisChoiceDays
                };
            });

            return `
        <div class="vacation-summary">
            <h3 class="summary-title">Resumen de Vacaciones ${currentYear}</h3>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Año Actual</th>
                        <th>Willis Choice</th>
                        <th class="total-column">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${summary.map(s => `
                        <tr>
                            <td class="member-name">${s.member}</td>
                            <td class="vacation-current">${s.currentYearDays.toFixed(1)}</td>
                            <td class="vacation-willis">${s.willisChoiceDays.toFixed(1)}</td>
                            <td class="total-column"><strong>${s.total.toFixed(1)}</strong></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
        }

        function previousMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            renderTeamView();
        }

        function nextMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            renderTeamView();
        }

        function toggleVacation(member, dateKey, event) {
            if (member !== currentUser) {
                alert('Solo puedes marcar tus propias vacaciones');
                return;
            }

            // Si es Ctrl+Clic, agregar a la selección múltiple
            if (event && event.ctrlKey) {
                event.preventDefault();
                const index = selectedVacationDays.findIndex(
                    d => d.member === member && d.dateKey === dateKey
                );

                if (index > -1) {
                    // Ya está seleccionado, remover
                    selectedVacationDays.splice(index, 1);
                } else {
                    // Agregar a la selección
                    selectedVacationDays.push({ member, dateKey });
                }

                renderTeamView();
                return;
            }

            // Clic normal: verificar si ya existe vacación en este día
            const existing = teamVacations.find(v =>
                v.user_initials === member &&
                v.start_date <= dateKey &&
                v.end_date >= dateKey
            );

            // Si existe vacación, permitir eliminarla siempre
            if (existing) {
                const confirmDelete = confirm(`¿Eliminar ${existing.days_count} día(s) de vacaciones?`);
                if (confirmDelete) {
                    deleteVacation(existing.id);
                }
                return;
            }

            // Si NO es Ctrl+Clic y hay selecciones previas sin vacaciones, mostrar alerta
            if (selectedVacationDays.length > 0) {
                alert('Ya tienes días seleccionados. Usa el botón "Añadir vacaciones" para confirmar o haz Ctrl+Clic en los días para deseleccionarlos.');
                return;
            }

            // Comportamiento normal: clic simple sin selecciones previas y sin vacaciones existentes
            showVacationOptionsModal(member, dateKey, [dateKey]);
        }

        function showVacationOptionsModal(member, startDateKey, dateKeysArray = []) {
            const currentYear = new Date().getFullYear();
            const previousYear = currentYear - 1;

            const yearChoice = prompt(
                `¿A qué año corresponden estas vacaciones?\n\n` +
                `1 - Año actual (${currentYear})\n` +
                `2 - Año anterior (${previousYear})\n` +
                `3 - Willis Choice\n\n` +
                `Introduce 1, 2 o 3:`
            );

            if (!yearChoice || !['1', '2', '3'].includes(yearChoice)) {
                return;
            }

            const daysInput = prompt('¿Cuántos días quieres computar? (ej: 1, 0.5, etc.)', '1');

            if (!daysInput) {
                return;
            }

            const days = parseFloat(daysInput);
            if (isNaN(days) || days <= 0) {
                alert('Número de días inválido');
                return;
            }

            let vacationType;
            let vacationYear;

            if (yearChoice === '1') {
                vacationType = 'current_year';
                vacationYear = currentYear;
            } else if (yearChoice === '2') {
                vacationType = 'previous_year';
                vacationYear = previousYear;
            } else {
                vacationType = 'willis_choice';
                vacationYear = currentYear;
            }

            // Si no hay fechas específicas, usar la del parámetro
            const datesToAdd = dateKeysArray.length > 0 ? dateKeysArray : [startDateKey];

            addVacationWithDateRange(member, datesToAdd, vacationType, vacationYear, days);
        }

        async function addVacationWithDateRange(member, dateKeysArray, vacationType, vacationYear, days) {
            if (!dateKeysArray || dateKeysArray.length === 0) return;

            // Crear un registro independiente por cada día
            // Esto permite borrar días individuales sin afectar a los demás
            const vacationRecords = dateKeysArray.map(dateKey => ({
                user_initials: member,
                start_date: dateKey,
                end_date: dateKey,
                status: 'planned',
                vacation_type: vacationType,
                vacation_year: vacationYear,
                days_count: days
            }));

            const { error } = await supabaseClient
                .from('team_vacations')
                .insert(vacationRecords);

            if (error) {
                console.error(error);
                alert('Error añadiendo vacación');
                return;
            }

            selectedVacationDays = [];
            await loadTeamVacations();
            renderTeamView();
        }

        async function addVacationWithDetails(member, dateKey, vacationType, vacationYear, days) {
            const { error } = await supabaseClient
                .from('team_vacations')
                .insert({
                    user_initials: member,
                    start_date: dateKey,
                    end_date: dateKey,
                    status: 'planned',
                    vacation_type: vacationType,
                    vacation_year: vacationYear,
                    days_count: days
                });

            if (error) {
                console.error(error);
                alert('Error añadiendo vacación');
                return;
            }

            await loadTeamVacations();
            renderTeamView();
        }


        async function deleteVacation(vacationId) {
            const { error } = await supabaseClient
                .from('team_vacations')
                .delete()
                .eq('id', vacationId);

            if (error) {
                console.error(error);
                alert('Error eliminando vacación');
                return;
            }

            await loadTeamVacations();
            renderTeamView();
        }

        async function loadTeamVacations() {
            const { data, error } = await supabaseClient
                .from('team_vacations')
                .select('*')
                .order('start_date', { ascending: true });

            if (error) {
                console.error(error);
                return;
            }

            teamVacations = data;
        }

        function openVacationModal() {
            if (selectedVacationDays.length === 0) {
                alert('Por favor, selecciona días usando Ctrl+Clic en el calendario');
                return;
            }

            // Agrupar por miembro (debería haber solo uno, pero lo hacemos robusto)
            const members = [...new Set(selectedVacationDays.map(d => d.member))];

            if (members.length > 1) {
                alert('Has seleccionado días de diferentes miembros del equipo. Por favor, selecciona solo tus días.');
                return;
            }

            const member = members[0];
            const dateKeys = selectedVacationDays.map(d => d.dateKey);

            showVacationOptionsModal(member, null, dateKeys);
        }


        function changeUser() {
            const newUser = prompt('Introduce tus iniciales (ej: IS, DH, HR...)', currentUser);
            if (newUser && newUser.trim()) {
                currentUser = newUser.trim().toUpperCase();
                localStorage.setItem('wtw_current_user', currentUser);
                updateUserDisplay();
            }
        }

        function updateUserDisplay() {
            const userNameEl = document.querySelector('.user-name');
            const userIconEl = document.querySelector('.user-icon');
            if (!userNameEl || !userIconEl) return;

            // Texto fijo debajo: "Usuario"
            userNameEl.textContent = 'Usuario';

            // Iniciales solo en el círculo
            const initials = currentUser.substring(0, 2).toUpperCase();
            userIconEl.textContent = initials;
        }




        async function init() {
            // 1. CARGAR USUARIO DESDE LOCALSTORAGE
            const savedUser = localStorage.getItem('wtw_current_user');

            if (savedUser) {
                // Si existe usuario guardado, usarlo
                currentUser = savedUser;
            } else {
                // Si es la primera vez, solicitar iniciales
                const newUser = prompt('👋 Bienvenido/a al gestor WTW\\n\\nIntroduce tus iniciales (ej: IS, DH, HR...)');

                if (newUser && newUser.trim()) {
                    currentUser = newUser.trim().toUpperCase();
                    localStorage.setItem('wtw_current_user', currentUser);
                } else {
                    // Si cancela, usar valor por defecto
                    currentUser = 'US';
                    localStorage.setItem('wtw_current_user', currentUser);
                }
            }

            // 2. ACTUALIZAR INTERFAZ CON EL USUARIO CARGADO
            updateUserDisplay();

            // 3. CONFIGURAR HEADERS DE SECCIONES COLAPSABLES
            setTimeout(() => {
                setupSidebarHeaders();
            }, 100);

            // 4. CARGAR DATOS
            await loadDataFromSupabase();
            await loadTeamVacations();
        }

        function setupSidebarHeaders() {
            const activosTitle = document.querySelector('.sidebar-title:nth-of-type(1)');
            const completadosTitle = document.querySelector('.sidebar-title:nth-of-type(2)');

            if (activosTitle) {
                activosTitle.style.cursor = 'pointer';
                activosTitle.style.transition = 'all 140ms ease';
                activosTitle.onclick = () => toggleSidebarSection('activos');
                const icon = document.createElement('span');
                icon.className = 'section-toggle-icon';
                icon.style.marginRight = '8px';
                icon.style.display = 'inline-block';
                icon.setAttribute('data-collapsed', sidebarCollapsed.activos ? 'true' : 'false');
                activosTitle.insertBefore(icon, activosTitle.firstChild);
            }

            if (completadosTitle) {
                completadosTitle.style.cursor = 'pointer';
                completadosTitle.style.transition = 'all 140ms ease';
                completadosTitle.onclick = () => toggleSidebarSection('completados');
                const icon = document.createElement('span');
                icon.className = 'section-toggle-icon';
                icon.style.marginRight = '8px';
                icon.style.display = 'inline-block';
                icon.setAttribute('data-collapsed', sidebarCollapsed.completados ? 'true' : 'false');
                completadosTitle.insertBefore(icon, completadosTitle.firstChild);
            }
        }

        window.addEventListener('load', init);

	</script>
</body>

</html>